<head>
    [% PageVersion = 'Header.tt,v 0.01 2023/08/30 shanta Exp shanta ' %]
    <meta charset="utf-8">
    [% IF c.session.debug_mode == 1 %]
        [% PageVersion %]
    [% END %]
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="REVISIT-AFTER" content="7 days">
    <meta name="ROBOTS" content="index all, follow all">
    [%# HostName = 'https://computersystemconsulting.ca' %]
    <meta charset="utf-8">
    <title>[% HostName _ ': ' _ ScriptDisplayName _ ': ' _ page_title %]</title>
    [% HostName = "http://computersystemconsulting.ca" %]
      <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="REVISIT-AFTER" content="7 days">
    <meta name="ROBOTS" content="index all, follow all">
    [% IF keywords %]
        <meta name="keywords" content="[% keywords %]">
    [% ELSE %]
        <meta name="keywords" content="[% data.http_header_keywords %]">
    [% END %]
    [% IF description %]
        <meta name="description" content="[% description %]">
    [% ELSE %]
        <meta name="description" content="[% http_header_description %]">
    [% END %]
<link rel="shortcut icon" href="[% favicon | uri('imagesfavicon.ico') %]">
    [% IF SiteName == "CSC" %]
        [% embed('CSCWHMCSInterface') %]
    [% END %]

    <!-- Base CSS with variables -->
    <link rel="stylesheet" type="text/css" href="/static/css/base.css">

    <!-- Theme CSS - based on site name -->
    [%
        # Default theme
        theme_name = 'default';

        # Set theme based on site name (fallback method)
        IF SiteName == 'USBM';
            theme_name = 'usbm';
        ELSIF SiteName == 'CSC';
            theme_name = 'csc';
        END;

        # Try to get theme from site record if the theme column exists
        # This is wrapped in a TRY block so it won't fail if the theme column doesn't exist
        TRY;
            # Use a safe method to check for the theme
            USE Dumper;

            # First check if the site exists at all
            site = c.model('DBEncy').resultset('Site').find(
                { name => SiteName },
                { columns => [qw(id name description)] }
            );

            IF site;
                # Now try to access the theme attribute safely
                TRY;
                    # Try to get the theme using a direct SQL query to avoid DBIC errors
                    dbh = c.model('DBEncy').schema.storage.dbh;
                    sth = dbh.prepare("SELECT theme FROM sites WHERE name = ?");
                    sth.execute(SiteName);
                    row = sth.fetchrow_arrayref;

                    IF row && row.0;
                        theme_name = row.0;
                        c.log.info("Using database theme: " _ theme_name);
                    END;
                CATCH;
                    # If there's an error, just use the name-based theme
                    c.log.info("Theme column not available, using name-based theme: " _ theme_name);
                END;
            END;
        CATCH;
            # If there's any error, just use the name-based theme
            c.log.error("Error accessing site data, using name-based theme: " _ theme_name);
        END;
    %]
    <link rel="stylesheet" type="text/css" href="/static/css/themes/[% theme_name %].css">

    <!-- Site-specific CSS (for backward compatibility) -->
    <link rel="stylesheet" type="text/css" href="[% c.stash.css_view_name %]">
    <link rel="stylesheet" type="text/css" href="[% c.stash.log_css %]">
    <link rel="stylesheet" type="text/css" href="[% c.stash.menu_css %]">
    <link rel="stylesheet" type="text/css" href="[% c.stash.todo_css %]">

    <script src="static/js/sub-menu.js"></script>
    <script language="javascript" type="text/javascript">
        function switchpage(select) {
            var index;
            for (index = 0; index < select.options.length; index++) {
                if (select.options[index].selected) {
                    if (select.options[index].value !== "") {
                        window.location.href = select.options[index].value;
                        break;
                    }
           }
            }
        }
    </script>
 </head>