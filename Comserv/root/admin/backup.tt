[% META title = 'Backup Management' %]
[% PageVersion = 'admin/backup.tt,v 0.01 2025/01/15 shanta Exp shanta ' %]

<h1>Backup Management <span class="csc-only">(CSC Hosting Only)</span></h1>

<div class="alert alert-info">
    <strong>Notice:</strong> This backup system is restricted to CSC hosting administrators only. 
    It provides secure backup and restore capabilities for hosted domains and applications.
</div>

[% IF debug_mode == 1 %]
    [% PageVersion %]
    <div class="debug">
        <p>Backup management page loaded</p>
        [% IF debug_msg %]
            [% FOREACH msg IN debug_msg %]
                <p>Debug: [% msg %]</p>
            [% END %]
        [% END %]
    </div>
[% END %]

<!-- Flash messages -->
[% IF c.flash.success_msg %]
    <div class="alert alert-success">
        [% c.flash.success_msg %]
    </div>
[% END %]

[% IF c.flash.error_msg %]
    <div class="alert alert-error">
        [% c.flash.error_msg %]
        [% IF c.flash.error_msg.match('Failed to create database backup') %]
            <div class="error-help">
                <p><strong>Troubleshooting Tips:</strong></p>
                <ul>
                    <li>Check database connection settings</li>
                    <li>Verify mysqldump is installed and accessible</li>
                    <li>Review <a href="[% c.uri_for('/admin/schema_compare') %]">schema status</a> for compatibility issues</li>
                    <li>Check application logs for detailed error information</li>
                </ul>
            </div>
        [% END %]
    </div>
[% END %]

<!-- Create Backup Section -->
<div class="backup-create-section">
    <h2>Create New Backup</h2>
    
    <form method="post" action="[% c.uri_for('/admin/backup/create') %]" class="backup-form">
        <div class="form-group">
            <label for="backup_type">Backup Type:</label>
            <select name="type" id="backup_type" required>
                <option value="full">Full Backup (Complete application)</option>
                <option value="database">Database Only</option>
                <option value="config">Configuration Files Only</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="description">Description (optional):</label>
            <input type="text" name="description" id="description" placeholder="Enter backup description">
        </div>
        
        <div class="form-actions">
            <button type="submit" class="btn btn-primary">Create Backup</button>
            <button type="button" class="btn btn-secondary" onclick="testDatabaseConnection()">Test Database Connection</button>
        </div>
    </form>
</div>

<!-- Existing Backups Section -->
<div class="backup-list-section">
    <h2>Existing Backups</h2>
    
    [% IF backups && backups.size > 0 %]
        <div class="backup-info">
            <p>Total backups: [% backups.size %]</p>
        </div>
        
        <table class="backup-table">
            <thead>
                <tr>
                    <th>Filename</th>
                    <th>Type</th>
                    <th>Date</th>
                    <th>Time</th>
                    <th>Size</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                [% FOREACH backup IN backups %]
                    <tr>
                        <td class="filename">[% backup.filename %]</td>
                        <td class="type">
                            <span class="backup-type backup-type-[% backup.type %]">
                                [% backup.type | ucfirst %]
                            </span>
                        </td>
                        <td class="date">[% backup.date %]</td>
                        <td class="time">[% backup.time %]</td>
                        <td class="size">[% backup.size %]</td>
                        <td class="actions">
                            <a href="[% c.uri_for('/admin/backup/download', backup.filename) %]" 
                               class="btn btn-small btn-download" title="Download backup">
                                Download
                            </a>
                            <a href="[% c.uri_for('/admin/backup/delete', backup.filename) %]" 
                               class="btn btn-small btn-danger btn-delete" 
                               onclick="return confirm('Are you sure you want to delete this backup? This action cannot be undone.')"
                               title="Delete backup">
                                Delete
                            </a>
                        </td>
                    </tr>
                [% END %]
            </tbody>
        </table>
    [% ELSE %]
        <div class="no-backups">
            <p>No backups found. Create your first backup using the form above.</p>
        </div>
    [% END %]
</div>

<!-- Backup Information -->
<div class="backup-info-section">
    <h2>Backup Information</h2>
    
    <div class="info-grid">
        <div class="info-item">
            <h3>Backup Types</h3>
            <ul>
                <li><strong>Full Backup:</strong> Complete application including all files, configurations, and database</li>
                <li><strong>Database Only:</strong> Just the database files</li>
                <li><strong>Configuration Files:</strong> Only configuration files and settings</li>
            </ul>
        </div>
        
        <div class="info-item">
            <h3>Storage Location</h3>
            <p>Backups are stored in the <code>backups/</code> directory within the application root. This directory is not tracked by version control to prevent blocking updates.</p>
        </div>
        
        <div class="info-item">
            <h3>File Format</h3>
            <p>All backups are compressed using gzip and stored as <code>.tar.gz</code> files for efficient storage and transfer.</p>
        </div>
        
        <div class="info-item">
            <h3>Security</h3>
            <p>Only administrators can create, download, or delete backups. All backup operations are logged for security auditing.</p>
        </div>
    </div>
</div>

<div class="navigation-links">
    <a href="[% c.uri_for('/admin') %]" class="btn btn-secondary">← Back to Admin Dashboard</a>
</div>

<script>
function testDatabaseConnection() {
    const button = event.target;
    const originalText = button.textContent;
    
    button.textContent = 'Testing...';
    button.disabled = true;
    
    fetch('[% c.uri_for('/admin/backup/test_db') %]')
        .then(response => response.json())
        .then(data => {
            let message = data.message;
            if (data.details) {
                message += '\n\nDetails:';
                if (data.details.dsn) message += '\nDSN: ' + data.details.dsn;
                if (data.details.user) message += '\nUser: ' + data.details.user;
                if (data.details.version) message += '\nDB Version: ' + data.details.version;
                if (data.details.mysqldump) message += '\nMySQLDump: ' + data.details.mysqldump;
            }
            
            if (data.success) {
                alert('✓ ' + message);
            } else {
                alert('✗ ' + message);
            }
        })
        .catch(error => {
            alert('Error testing database connection: ' + error);
        })
        .finally(() => {
            button.textContent = originalText;
            button.disabled = false;
        });
}
</script>