[% META 
   title = 'DNS Records for ' _ domain
   css = ['components/cloudflare.css']
%]

<div class="cloudflare-container">
    <h1>DNS Records for [% domain %]</h1>
    
    [% IF error_message %]
    <div class="alert alert-danger">
        <strong>Error:</strong> [% error_message %]
        <p>This could be due to one of the following reasons:</p>
        <ul>
            <li>The domain is not registered in Cloudflare</li>
            <li>There's an issue with the Cloudflare API credentials</li>
            <li>You don't have permission to access this domain's DNS records</li>
        </ul>
        <p>Please contact your administrator if this problem persists.</p>
    </div>
    [% END %]
    
    <div class="dns-header">
        <div class="dns-actions">
            <button id="add-record-btn" class="btn btn-success" [% IF error_message %]disabled="disabled"[% END %]>Add Record</button>
            <button id="purge-cache-btn" class="btn btn-warning" [% IF error_message %]disabled="disabled"[% END %]>Purge Cache</button>
            <button id="back-to-sites-btn" class="btn btn-secondary">Back to Sites</button>
        </div>
    </div>
    
    <div class="dns-records-table">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>Type</th>
                    <th>Name</th>
                    <th>Content</th>
                    <th>TTL</th>
                    <th>Proxied</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="dns-records-body">
                [% IF records.size > 0 %]
                    [% FOREACH record IN records %]
                        <tr>
                            <td>[% record.type %]</td>
                            <td>[% record.name %]</td>
                            <td>[% record.content %]</td>
                            <td>[% record.ttl == 1 ? 'Auto' : record.ttl %]</td>
                            <td>[% record.proxied ? 'Yes' : 'No' %]</td>
                            <td>
                                <button class="btn btn-sm btn-primary edit-record-btn" 
                                    data-record-id="[% record.id %]"
                                    data-record-type="[% record.type %]"
                                    data-record-name="[% record.name %]"
                                    data-record-content="[% record.content %]"
                                    data-record-ttl="[% record.ttl %]"
                                    data-record-proxied="[% record.proxied ? 1 : 0 %]">
                                    Edit
                                </button>
                            </td>
                        </tr>
                    [% END %]
                [% ELSE %]
                    <tr>
                        <td colspan="6" class="text-center">
                            [% IF error_message %]
                                No records available due to an error.
                            [% ELSE %]
                                No DNS records found for this domain.
                            [% END %]
                        </td>
                    </tr>
                [% END %]
            </tbody>
        </table>
    </div>
</div>

<!-- Add Record Modal -->
<div class="modal fade" id="add-record-modal" tabindex="-1" role="dialog" aria-labelledby="addRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addRecordModalLabel">Add DNS Record</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="add-record-form">
                    <input type="hidden" id="domain-input" name="domain" value="[% domain %]">
                    
                    <div class="form-group">
                        <label for="record-type">Record Type</label>
                        <select class="form-control" id="record-type" name="type" required>
                            <option value="A">A</option>
                            <option value="AAAA">AAAA</option>
                            <option value="CNAME">CNAME</option>
                            <option value="TXT">TXT</option>
                            <option value="MX">MX</option>
                            <option value="NS">NS</option>
                            <option value="SRV">SRV</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="record-name">Name</label>
                        <input type="text" class="form-control" id="record-name" name="name" required>
                        <small class="form-text text-muted">Use @ for root domain</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="record-content">Content</label>
                        <input type="text" class="form-control" id="record-content" name="content" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="record-ttl">TTL</label>
                        <select class="form-control" id="record-ttl" name="ttl">
                            <option value="1">Automatic</option>
                            <option value="120">2 minutes</option>
                            <option value="300">5 minutes</option>
                            <option value="600">10 minutes</option>
                            <option value="1800">30 minutes</option>
                            <option value="3600">1 hour</option>
                            <option value="7200">2 hours</option>
                            <option value="18000">5 hours</option>
                            <option value="43200">12 hours</option>
                            <option value="86400">1 day</option>
                        </select>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="record-proxied" name="proxied">
                        <label class="form-check-label" for="record-proxied">Proxied</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="save-record-btn">Save Record</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Record Modal -->
<div class="modal fade" id="edit-record-modal" tabindex="-1" role="dialog" aria-labelledby="editRecordModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editRecordModalLabel">Edit DNS Record</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="edit-record-form">
                    <input type="hidden" id="edit-domain-input" name="domain" value="[% domain %]">
                    <input type="hidden" id="edit-record-id" name="record_id">
                    
                    <div class="form-group">
                        <label for="edit-record-type">Record Type</label>
                        <select class="form-control" id="edit-record-type" name="type" required>
                            <option value="A">A</option>
                            <option value="AAAA">AAAA</option>
                            <option value="CNAME">CNAME</option>
                            <option value="TXT">TXT</option>
                            <option value="MX">MX</option>
                            <option value="NS">NS</option>
                            <option value="SRV">SRV</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-record-name">Name</label>
                        <input type="text" class="form-control" id="edit-record-name" name="name" required>
                        <small class="form-text text-muted">Use @ for root domain</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-record-content">Content</label>
                        <input type="text" class="form-control" id="edit-record-content" name="content" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="edit-record-ttl">TTL</label>
                        <select class="form-control" id="edit-record-ttl" name="ttl">
                            <option value="1">Automatic</option>
                            <option value="120">2 minutes</option>
                            <option value="300">5 minutes</option>
                            <option value="600">10 minutes</option>
                            <option value="1800">30 minutes</option>
                            <option value="3600">1 hour</option>
                            <option value="7200">2 hours</option>
                            <option value="18000">5 hours</option>
                            <option value="43200">12 hours</option>
                            <option value="86400">1 day</option>
                        </select>
                    </div>
                    
                    <div class="form-check">
                        <input type="checkbox" class="form-check-input" id="edit-record-proxied" name="proxied">
                        <label class="form-check-label" for="edit-record-proxied">Proxied</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="delete-record-btn">Delete</button>
                <button type="button" class="btn btn-primary" id="update-record-btn">Update Record</button>
            </div>
        </div>
    </div>
</div>

<script>
$(document).ready(function() {
    // Back to sites
    $('#back-to-sites-btn').click(function() {
        window.location.href = '[% c.uri_for("/cloudflareapi") %]';
    });
    
    // Add record button
    $('#add-record-btn').click(function() {
        $('#add-record-modal').modal('show');
    });
    
    // Save record
    $('#save-record-btn').click(function() {
        const formData = $('#add-record-form').serialize();
        
        $.ajax({
            url: '[% c.uri_for("/cloudflareapi/dns/create") %]',
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert('DNS record created successfully');
                    $('#add-record-modal').modal('hide');
                    window.location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', xhr.responseText);
                let errorMessage = 'Error creating DNS record';
                
                try {
                    // Try to parse the response as JSON
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse && errorResponse.error) {
                        errorMessage += ': ' + errorResponse.error;
                    }
                } catch (e) {
                    // If parsing fails, use the raw error
                    errorMessage += ': ' + error;
                }
                
                alert(errorMessage);
            }
        });
    });
    
    // Edit record
    $('.edit-record-btn').click(function() {
        const recordId = $(this).data('record-id');
        const recordType = $(this).data('record-type');
        const recordName = $(this).data('record-name');
        const recordContent = $(this).data('record-content');
        const recordTtl = $(this).data('record-ttl');
        const recordProxied = $(this).data('record-proxied') === 1;
        
        $('#edit-record-id').val(recordId);
        $('#edit-record-type').val(recordType);
        $('#edit-record-name').val(recordName);
        $('#edit-record-content').val(recordContent);
        $('#edit-record-ttl').val(recordTtl);
        $('#edit-record-proxied').prop('checked', recordProxied);
        
        $('#edit-record-modal').modal('show');
    });
    
    // Update record
    $('#update-record-btn').click(function() {
        const formData = $('#edit-record-form').serialize();
        
        $.ajax({
            url: '[% c.uri_for("/cloudflareapi/dns/update") %]',
            type: 'POST',
            data: formData,
            dataType: 'json',
            success: function(response) {
                if (response.success) {
                    alert('DNS record updated successfully');
                    $('#edit-record-modal').modal('hide');
                    window.location.reload();
                } else {
                    alert('Error: ' + (response.error || 'Unknown error'));
                }
            },
            error: function(xhr, status, error) {
                console.error('AJAX Error:', xhr.responseText);
                let errorMessage = 'Error updating DNS record';
                
                try {
                    // Try to parse the response as JSON
                    const errorResponse = JSON.parse(xhr.responseText);
                    if (errorResponse && errorResponse.error) {
                        errorMessage += ': ' + errorResponse.error;
                    }
                } catch (e) {
                    // If parsing fails, use the raw error
                    errorMessage += ': ' + error;
                }
                
                alert(errorMessage);
            }
        });
    });
    
    // Delete record
    $('#delete-record-btn').click(function() {
        if (confirm('Are you sure you want to delete this DNS record?')) {
            const domain = $('#edit-domain-input').val();
            const recordId = $('#edit-record-id').val();
            
            $.ajax({
                url: '[% c.uri_for("/cloudflareapi/dns/delete") %]',
                type: 'POST',
                data: {
                    domain: domain,
                    record_id: recordId
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('DNS record deleted successfully');
                        $('#edit-record-modal').modal('hide');
                        window.location.reload();
                    } else {
                        alert('Error: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText);
                    let errorMessage = 'Error deleting DNS record';
                    
                    try {
                        // Try to parse the response as JSON
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.error) {
                            errorMessage += ': ' + errorResponse.error;
                        }
                    } catch (e) {
                        // If parsing fails, use the raw error
                        errorMessage += ': ' + error;
                    }
                    
                    alert(errorMessage);
                }
            });
        }
    });
    
    // Purge cache
    $('#purge-cache-btn').click(function() {
        if (confirm('Are you sure you want to purge the cache for this domain?')) {
            $.ajax({
                url: '[% c.uri_for("/cloudflareapi/cache/purge") %]',
                type: 'POST',
                data: {
                    domain: '[% domain %]'
                },
                dataType: 'json',
                success: function(response) {
                    if (response.success) {
                        alert('Cache purged successfully');
                    } else {
                        alert('Error: ' + (response.error || 'Unknown error'));
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX Error:', xhr.responseText);
                    let errorMessage = 'Error purging cache';
                    
                    try {
                        // Try to parse the response as JSON
                        const errorResponse = JSON.parse(xhr.responseText);
                        if (errorResponse && errorResponse.error) {
                            errorMessage += ': ' + errorResponse.error;
                        }
                    } catch (e) {
                        // If parsing fails, use the raw error
                        errorMessage += ': ' + error;
                    }
                    
                    alert(errorMessage);
                }
            });
        }
    });
});
</script>