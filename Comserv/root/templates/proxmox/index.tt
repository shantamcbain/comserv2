[% META title = 'Proxmox VM Management' %]
[% PageVersion = 'proxmox/index.tt,v 0.01 2025/04/07 Admin Exp admin ' %]

<div class="proxmox-container">
    <h1>Proxmox VM Management</h1>
    
    <div class="proxmox-documentation-link">
        <a href="[% c.uri_for('/Documentation/KVM_ISO_Transfer') %]" class="btn btn-info">
            <i class="fa fa-book"></i> KVM ISO File Transfer Documentation
        </a>
    </div>
    
    <div class="server-selector">
        <form method="get" action="[% c.uri_for('/proxmox') %]">
            <label for="server_id">Select Proxmox Server:</label>
            <select name="server_id" id="server_id" onchange="this.form.submit()">
                [% FOREACH server_key IN servers.keys.sort %]
                <option value="[% server_key %]" [% IF server_id == server_key %]selected[% END %]>
                    [% servers.$server_key.name || server_key %]
                </option>
                [% END %]
            </select>
        </form>
    </div>
    
    [% IF auth_error %]
    <div class="alert alert-danger">
        <strong>Error:</strong> [% auth_error %]
    </div>
    [% END %]
    
    [% IF auth_success %]
    <div class="vm-management">
        <div class="vm-actions">
            <a href="[% c.uri_for('/proxmox/create') %]" class="btn btn-primary">
                <i class="fa fa-plus"></i> Create New VM
            </a>
        </div>
        
        <h2>Virtual Machines</h2>
        
        [% IF vms.size > 0 %]
        <div class="vm-list">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>VMID</th>
                        <th>Name</th>
                        <th>Status</th>
                        <th>CPU</th>
                        <th>Memory</th>
                        <th>Disk</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    [% FOREACH vm IN vms %]
                    <tr>
                        <td>[% vm.vmid %]</td>
                        <td>[% vm.name %]</td>
                        <td>
                            <span class="status-indicator [% vm.status %]">[% vm.status %]</span>
                        </td>
                        <td>[% vm.cpu %] vCPU</td>
                        <td>[% vm.memory %] MB</td>
                        <td>[% vm.disk %] GB</td>
                        <td class="vm-actions">
                            <button class="btn btn-sm btn-success" onclick="startVM([% vm.vmid %])">Start</button>
                            <button class="btn btn-sm btn-warning" onclick="stopVM([% vm.vmid %])">Stop</button>
                            <button class="btn btn-sm btn-danger" onclick="confirmDelete([% vm.vmid %])">Delete</button>
                        </td>
                    </tr>
                    [% END %]
                </tbody>
            </table>
        </div>
        [% ELSE %]
        <div class="alert alert-info">
            No virtual machines found on this Proxmox server.
        </div>
        [% END %]
    </div>
    [% END %]
</div>

<style>
    .proxmox-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .server-selector {
        margin: 20px 0;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 5px;
    }
    
    .vm-management {
        margin-top: 30px;
    }
    
    .vm-actions {
        margin-bottom: 20px;
    }
    
    .status-indicator {
        display: inline-block;
        padding: 3px 8px;
        border-radius: 3px;
        font-weight: bold;
    }
    
    .status-indicator.running {
        background-color: #d4edda;
        color: #155724;
    }
    
    .status-indicator.stopped {
        background-color: #f8d7da;
        color: #721c24;
    }
    
    .proxmox-documentation-link {
        margin: 20px 0;
        padding: 15px;
        background-color: #e6f7ff;
        border-radius: 5px;
        border-left: 4px solid #1890ff;
    }
</style>

<script>
    function startVM(vmid) {
        if (confirm('Are you sure you want to start VM ' + vmid + '?')) {
            // Add AJAX call to start VM
            alert('Starting VM ' + vmid + '...');
        }
    }
    
    function stopVM(vmid) {
        if (confirm('Are you sure you want to stop VM ' + vmid + '?')) {
            // Add AJAX call to stop VM
            alert('Stopping VM ' + vmid + '...');
        }
    }
    
    function confirmDelete(vmid) {
        if (confirm('WARNING: This will permanently delete VM ' + vmid + '. Are you sure?')) {
            // Add AJAX call to delete VM
            alert('Deleting VM ' + vmid + '...');
        }
    }
</script>