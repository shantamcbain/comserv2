[% PageVersion = 'ENCY/HerbView.tt,v 0.01 2025/01/19 Shanta Exp shanta ' %]
[% IF c.session.debug_mode == 1 %]
    [% PageVersion %]
[% END %]

[% IF mode == 'view' || edit_mode == 0 %]
    <h1>[% herb.botanical_name %]</h1>
[% ELSE %]
    <h1>[% edit_mode == 1 ? 'Editing Herb: ' : 'Add New Herb' %] [% herb.botanical_name %]</h1>
[% END %]

[% IF c.req.param('message') %]
    <p class="error">[% c.req.param('message') | html %]</p>
[% END %]
[% IF mode == 'view' || edit_mode == 0 %]
    <div>
        <a href="[% c.uri_for('/ENCY/BotanicalNameView') %]">Back to Botanical Name View</a>
        [% IF c.session.roles.grep('admin').size %]
            <!-- Debug info to help troubleshoot edit link -->
            [% IF c.session.debug_mode == 1 %]
                <div class="debug-info">
                    Record ID from herb object: [% herb.record_id %]
                </div>
            [% END %]
            
            <!-- Make sure we're passing the record_id parameter correctly -->
            <a href="[% c.uri_for('/ENCY/edit_herb') %]?id=[% herb.record_id %]">Edit Herb</a>
            | <a href="[% c.uri_for('/ENCY/delete_herb', herb.record_id) %]" 
                 onclick="return confirm('Are you sure you want to delete this herb? This action cannot be undone.')" 
                 style="color: red;">Delete Herb</a>
        [% END %]
    </div>
[% END %]
Record ID:[% herb.record_id %]
[% IF mode != 'view' && edit_mode == 1 %]
    <form action="[% c.uri_for('/ENCY/edit_herb') %]" method="post" enctype="multipart/form-data" onsubmit="return prepareFormSubmission()">
        [% IF edit_mode == 1 %]
            <input type="hidden" name="record_id" value="[% herb.record_id %]" />
        [% END %]
        <input type="submit" value="[% mode == 'add' ? 'Add Herb' : 'Update Herb' %]" class="top-submit" />
[% END %]

<table>
    <tr>
        <th colspan="2"><h2>Naming</h2></th>
    </tr>
    <tr>
        <td>Botanical Name:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.botanical_name %]
            [% ELSE %]
                <input type="text" id="botanical_name" name="botanical_name" value="[% herb.botanical_name %]" size="50" required />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Common Names:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.common_names %]
            [% ELSE %]
                <input type="text" id="common_names" name="common_names" value="[% herb.common_names %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Key Name:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.key_name %]
            [% ELSE %]
                <input type="text" id="key_name" name="key_name" value="[% herb.key_name %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Parts Used:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.parts_used %]
            [% ELSE %]
                <input type="text" id="parts_used" name="parts_used" value="[% herb.parts_used %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Sister Plants:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.sister_plants %]
            [% ELSE %]
                <input type="text" id="sister_plants" name="sister_plants" value="[% herb.sister_plants %]" size="50" required />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Comments:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.comments %]
            [% ELSE %]
                <textarea id="comments" name="comments" rows="4" cols="50">[% herb.comments %]</textarea>
            [% END %]
        </td>
    </tr>

    <tr>
        <th colspan="2"><h2>Characteristics</h2></th>
    </tr>
    <tr>
        <td>Identifying Character:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.ident_character %]
            [% ELSE %]
                <input type="text" id="ident_character" name="ident_character" value="[% herb.ident_character %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Stem:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.stem %]
            [% ELSE %]
                <input type="text" id="stem" name="stem" value="[% herb.stem %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Leaves:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.leaves %]
            [% ELSE %]
                <input type="text" id="leaves" name="leaves" value="[% herb.leaves %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Flowers:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.flowers %]
            [% ELSE %]
                <input type="text" id="flowers" name="flowers" value="[% herb.flowers %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Fruit:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.fruit %]
            [% ELSE %]
                <input type="text" id="fruit" name="fruit" value="[% herb.fruit %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Taste:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.taste %]
            [% ELSE %]
                <input type="text" id="taste" name="taste" value="[% herb.taste %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Odour:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.odour %]
            [% ELSE %]
                <input type="text" id="odour" name="odour" value="[% herb.odour %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Root:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.root %]
            [% ELSE %]
                <input type="text" id="root" name="root" value="[% herb.root %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Image:</td>
        <td>
            <!-- Debug: mode=[% mode %], edit_mode=[% edit_mode %], image=[% herb.image %] -->
            [% IF edit_mode != 1 %]
                [% IF herb.image && herb.image != '' %]
                    <img src="[% herb.image %]" width="300" height="325" alt="[% herb.botanical_name %]" />
                    <br><small>Image URL: [% herb.image %]</small>
                [% ELSE %]
                    <em>No image available</em>
                [% END %]
            [% ELSE %]
                [% IF c.session.roles.grep('admin').size %]
                    <div id="image-management">
                        <!-- Current Image Display -->
                        [% IF herb.image %]
                            <div id="current-image">
                                <strong>Current image:</strong><br>
                                <img src="[% herb.image %]" width="200" height="200" alt="Current image" style="border: 1px solid #ccc; margin: 5px 0;" />
                                <br><small>Current URL: [% herb.image %]</small>
                            </div>
                            <br>
                        [% END %]
                        
                        <!-- Simple Image URL Input (Primary Option) -->
                        <div>
                            <label for="image_url_simple"><strong>Image URL (direct entry):</strong></label><br>
                            <input type="url" id="image_url_simple" name="image_url_simple" value="[% herb.image %]" size="60" placeholder="Enter image URL" />
                            <br><small>Enter the image URL directly - this will be saved as-is to the database</small>
                        </div>
                        
                        <br><strong>OR use advanced options:</strong><br><br>
                        
                        <!-- Image URL Input with Preview -->
                        <div>
                            <label for="image_url">Image URL (will be downloaded and stored locally):</label><br>
                            <input type="url" id="image_url" name="image_url" value="" size="60" placeholder="Enter image URL to download" />
                            <button type="button" id="preview-url-btn" onclick="previewImageFromUrl()">Preview</button>
                            <button type="button" id="remove-image-btn" onclick="removeImage()">Remove Image</button>
                            <br><small>Enter a URL and click Preview to see the image before saving, or click Remove Image to delete the current image</small>
                            <div id="url-preview" style="margin-top: 10px; display: none;">
                                <img id="url-preview-img" src="" width="150" height="150" style="border: 1px solid #ccc;" />
                            </div>
                        </div>
                        
                        <br><strong>OR</strong><br><br>
                        
                        <!-- File Upload -->
                        <div>
                            <label for="image_upload">Upload new image:</label><br>
                            <input type="file" id="image_upload" name="image_upload" accept="image/*" onchange="previewUploadedFile(this)" />
                            <br><small>Supported formats: JPG, PNG, GIF (max 5MB)</small>
                            <div id="upload-preview" style="margin-top: 10px; display: none;">
                                <img id="upload-preview-img" src="" width="150" height="150" style="border: 1px solid #ccc;" />
                            </div>
                        </div>
                        
                        <br><strong>OR</strong><br><br>
                        
                        <!-- Existing Images Browser -->
                        <div>
                            <label>Select from existing images:</label><br>
                            <select id="existing_image" name="existing_image" onchange="previewExistingImage(this)">
                                <option value="">-- Select existing image --</option>
                                [% IF existing_images %]
                                    [% FOREACH img IN existing_images %]
                                        <option value="[% img.url %]">[% img.filename %]</option>
                                    [% END %]
                                [% END %]
                            </select>
                            <div id="existing-preview" style="margin-top: 10px; display: none;">
                                <img id="existing-preview-img" src="" width="150" height="150" style="border: 1px solid #ccc;" />
                            </div>
                        </div>
                        
                        <!-- Hidden field to store the final image choice -->
                        <input type="hidden" id="final_image_choice" name="image_action" value="" />
                    </div>
                    
                    <script>
                        function previewImageFromUrl() {
                            var url = document.getElementById('image_url').value;
                            if (url) {
                                var preview = document.getElementById('url-preview');
                                var img = document.getElementById('url-preview-img');
                                img.src = url;
                                img.onerror = function() {
                                    alert('Could not load image from URL. Please check the URL.');
                                    preview.style.display = 'none';
                                };
                                img.onload = function() {
                                    preview.style.display = 'block';
                                    document.getElementById('final_image_choice').value = 'url:' + url;
                                };
                            }
                        }
                        
                        function previewUploadedFile(input) {
                            if (input.files && input.files[0]) {
                                var reader = new FileReader();
                                reader.onload = function(e) {
                                    var preview = document.getElementById('upload-preview');
                                    var img = document.getElementById('upload-preview-img');
                                    img.src = e.target.result;
                                    preview.style.display = 'block';
                                    document.getElementById('final_image_choice').value = 'upload';
                                };
                                reader.readAsDataURL(input.files[0]);
                            }
                        }
                        
                        function previewExistingImage(select) {
                            var url = select.value;
                            if (url) {
                                var preview = document.getElementById('existing-preview');
                                var img = document.getElementById('existing-preview-img');
                                img.src = url;
                                preview.style.display = 'block';
                                document.getElementById('final_image_choice').value = 'existing:' + url;
                            } else {
                                document.getElementById('existing-preview').style.display = 'none';
                            }
                        }
                        
                        function removeImage() {
                            // Clear all image inputs and previews
                            document.getElementById('image_url_simple').value = '';
                            document.getElementById('image_url').value = '';
                            document.getElementById('url-preview').style.display = 'none';
                            document.getElementById('upload-preview').style.display = 'none';
                            document.getElementById('existing-preview').style.display = 'none';
                            
                            // Clear file upload
                            var fileInput = document.getElementById('image_upload');
                            if (fileInput) fileInput.value = '';
                            
                            // Clear existing image selection
                            var existingSelect = document.getElementById('existing_image');
                            if (existingSelect) existingSelect.value = '';
                            
                            // Set action to remove image
                            document.getElementById('final_image_choice').value = 'remove';
                        }
                        
                        function prepareFormSubmission() {
                            // Check for simple image URL input first (highest priority)
                            var simpleImageUrl = document.getElementById('image_url_simple');
                            var imageAction = document.getElementById('final_image_choice');
                            
                            if (simpleImageUrl && simpleImageUrl.value && simpleImageUrl.value.trim() !== '') {
                                // User entered a simple image URL, set the action to use it directly
                                imageAction.value = 'simple:' + simpleImageUrl.value.trim();
                                return true;
                            }
                            
                            // Check if user entered a URL in the advanced field but didn't click Preview
                            var imageUrl = document.getElementById('image_url');
                            
                            if (imageUrl && imageUrl.value && (!imageAction.value || imageAction.value === '')) {
                                // User entered a URL but didn't preview it, set the action automatically
                                imageAction.value = 'url:' + imageUrl.value;
                            }
                            
                            return true; // Allow form submission to continue
                        }
                    </script>
                [% ELSE %]
                    <input type="url" id="image" name="image" value="[% herb.image %]" size="50" />
                [% END %]
            [% END %]
        </td>
    </tr>

    <tr>
        <th colspan="2"><h2>Distribution</h2></th>
    </tr>
    <tr>
        <td>Distribution:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.distribution %]
            [% ELSE %]
                <input type="text" id="distribution" name="distribution" value="[% herb.distribution %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Cultivation:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.cultivation %]
            [% ELSE %]
                <input type="text" id="cultivation" name="cultivation" value="[% herb.cultivation %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Harvest:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.harvest %]
            [% ELSE %]
                <input type="text" id="harvest" name="harvest" value="[% herb.harvest %]" size="50" />
            [% END %]
        </td>
    </tr>

    <tr>
        <th colspan="2"><h2>Medical</h2></th>
    </tr>
    <tr>
        <td>Therapeutic Action:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.therapeutic_action %]
            [% ELSE %]
                <textarea id="therapeutic_action" name="therapeutic_action" rows="4" cols="50">[% herb.therapeutic_action %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Medical Uses:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.medical_uses %]
            [% ELSE %]
                <textarea id="medical_uses" name="medical_uses" rows="4" cols="50">[% herb.medical_uses %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Constituents:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.constituents %]
            [% ELSE %]
                <textarea id="constituents" name="constituents" rows="4" cols="50">[% herb.constituents %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Solvents:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.solvents %]
            [% ELSE %]
                <input type="text" id="solvents" name="solvents" value="[% herb.solvents %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Dosage:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.dosage %]
            [% ELSE %]
                <input type="text" id="dosage" name="dosage" value="[% herb.dosage %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Administration:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.administration %]
            [% ELSE %]
                <input type="text" id="administration" name="administration" value="[% herb.administration %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Formulas:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.formulas %]
            [% ELSE %]
                <textarea id="formulas" name="formulas" rows="4" cols="50">[% herb.formulas %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Contra Indications:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.contra_indications %]
            [% ELSE %]
                <textarea id="contra_indications" name="contra_indications" rows="4" cols="50">[% herb.contra_indications %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Preparation:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.preparation %]
            [% ELSE %]
                <textarea id="preparation" name="preparation" rows="4" cols="50" required>[% herb.preparation %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Chinese:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.chinese %]
            [% ELSE %]
                <input type="text" id="chinese" name="chinese" value="[% herb.chinese %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Veterinary:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.vetrinary %]
            [% ELSE %]
                <input type="text" id="vetrinary" name="vetrinary" value="[% herb.vetrinary %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Homeopathic:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.homiopathic %]
            [% ELSE %]
                <input type="text" id="homiopathic" name="homiopathic" value="[% herb.homiopathic %]" size="50" />
            [% END %]
        </td>
    </tr>

    <tr>
        <th colspan="2"><h2>Pollination and Pollinators</h2></th>
    </tr>
 <tr>
    <td>Apis:</td>
    <td>
        [% IF mode == 'view' || edit_mode == 0 %]
            [% herb.apis == 1 ? 'Yes' : 'No' %]
        [% ELSE %]
            <select id="apis" name="apis">
                <option value="0" [% IF herb.apis == 0 %]selected[% END %]>No</option>
                <option value="1" [% IF herb.apis == 1 %]selected[% END %]>Yes</option>
            </select>
        [% END %]
    </td>
</tr>

    <tr>
        <td>Pollinator:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.pollinator %]
            [% ELSE %]
                <input type="text" id="pollinator" name="pollinator" value="[% herb.pollinator %]" size="50" />
            [% END %]
        </td>
    </tr>
<tr>
    <td>Pollen:</td>
    <td>
        [% IF mode == 'view' || edit_mode == 0 %]
            [% herb.pollen == 1 ? 'Yes' : 'No' %]
        [% ELSE %]
            <select id="pollen" name="pollen">
                <option value="0" [% IF herb.pollen == 0 %]selected[% END %]>No</option>
                <option value="1" [% IF herb.pollen == 1 %]selected[% END %]>Yes</option>
            </select>
        [% END %]
    </td>
</tr>
    <tr>
        <td>Pollen Notes:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.pollennotes %]
            [% ELSE %]
                <textarea id="pollennotes" name="pollennotes" rows="4" cols="50">[% herb.pollennotes %]</textarea>
            [% END %]
        </td>
    </tr>
<tr>
    <td>Nectar:</td>
    <td>
        [% IF mode == 'view' || edit_mode == 0 %]
            [% herb.nectar == 1 ? 'Yes' : 'No' %]
        [% ELSE %]
            <select id="nectar" name="nectar">
                <option value="0" [% IF herb.nectar == 0 %]selected[% END %]>No</option>
                <option value="1" [% IF herb.nectar == 1 %]selected[% END %]>Yes</option>
            </select>
        [% END %]
    </td>
</tr>

    <tr>
        <td>Nectar Notes:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.nectarnotes %]
            [% ELSE %]
                <textarea id="nectarnotes" name="nectarnotes" rows="4" cols="50">[% herb.nectarnotes %]</textarea>
            [% END %]
        </td>
    </tr>

    <tr>
        <th colspan="2"><h2>Other</h2></th>
    </tr>
    <tr>
        <td>Non-Medical Uses:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.non_med %]
            [% ELSE %]
                <textarea id="non_med" name="non_med" rows="4" cols="50">[% herb.non_med %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Culinary Uses:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.Culinary %]
            [% ELSE %]
                <input type="text" id="culinary" name="culinary" value="[% herb.Culinary %]" size="50" />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>History:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.history %]
            [% ELSE %]
                <textarea id="history" name="history" rows="4" cols="50">[% herb.history %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Reference:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.reference %]
            [% ELSE %]
                <textarea id="reference" name="reference" rows="4" cols="50">[% herb.reference %]</textarea>
            [% END %]
        </td>
    </tr>
    <tr>
        <td>URL:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                <a href="[% herb.url %]">[% herb.url %]</a>
            [% ELSE %]
                <input type="url" id="url" name="url" value="[% herb.url %]" size="50" required />
            [% END %]
        </td>
    </tr>
    <tr>
        <td>Share:</td>
        <td>
            [% IF mode == 'view' || edit_mode == 0 %]
                [% herb.share == 0 ? 'Public' : 'Private' %]
            [% ELSE %]
                <select id="share" name="share">
                    <option value="0" [% IF herb.share == 0 %]selected[% END %]>Public</option>
                    <option value="1" [% IF herb.share == 1 %]selected[% END %]>Private</option>
                </select>
            [% END %]
        </td>
    </tr>
</table>

[% IF mode != 'view' && edit_mode == 1 %]
        <input type="submit" value="[% edit_mode == 1 ? 'Update Herb' : 'Add Herb' %]" />

</form>
[% END %]
