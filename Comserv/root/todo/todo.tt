[% PageVersion  = 'todo.tt,v 1.1 2025/01/27 Shanta Exp Shanta' %]
[% IF debug_mode == 1 %]
    [% PageVersion %]
    [%# "Debugging HostName: " _ HostName %]
    [% INCLUDE 'debug.tt' %]
[% END %]

<div class="apiary-container">
    <div class="feature-header">
        <h1>ToDo List</h1>
        <h2>[% date_today %]</h2>
    </div>

[% IF overdue_todos.size > 0 %]
<div class="feature-card">
    <div class="feature-header" onclick="toggleOverdueSection()" style="cursor: pointer;">
        <h3>
            <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
            <span class="overdue-icon-text" data-site="[% c.session.SiteName || 'default' %]" title="Tasks that are past their due date">Overdue TODOs</span> ([% overdue_todos.size %])
            <span class="overdue-toggle-icon" id="overdue-toggle-icon" title="Click to expand/collapse overdue tasks" style="margin-left: auto;">&#9660;</span>
        </h3>
    </div>
    <div class="feature-content overdue-list" id="overdue-list" style="display: none;">
        [% FOREACH todo IN overdue_todos %]
        <div class="overdue-item" style="background: var(--card-bg); border: 1px solid var(--border-color); border-radius: 6px; padding: 12px; margin-bottom: 10px; border-left: 3px solid var(--warning-color);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%; gap: 15px;">
                <!-- Left side: Subject and meta info -->
                <div style="flex: 1; min-width: 0;">
                    <h4 style="margin: 0 0 8px 0; font-size: 1.1em; color: var(--text-color);">[% todo.subject %]</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9em; color: var(--text-color);">
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <strong>Priority:</strong>
                            <span class="priority-badge" style="padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; background-color: [% IF todo.priority == 1 %]var(--warning-color)[% ELSIF todo.priority == 2 %]var(--accent-color)[% ELSE %]var(--success-color)[% END %]; color: white;">
                                [% IF todo.priority == 1 %]High
                                [% ELSIF todo.priority == 2 %]Medium  
                                [% ELSIF todo.priority == 3 %]Normal
                                [% ELSE %][% todo.priority %]
                                [% END %]
                            </span>
                        </span>
                        [% IF todo.due_date %]
                        <span><strong>Due:</strong> [% todo.due_date %]</span>
                        [% END %]
                        [% IF todo.project %]
                        <span><strong>Project:</strong> [% todo.project.name %]</span>
                        [% END %]
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <strong>Status:</strong>
                            <span class="status-badge" style="padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; background-color: [% IF todo.status == 1 %]var(--info-color)[% ELSIF todo.status == 2 %]var(--accent-color)[% ELSE %]var(--success-color)[% END %]; color: white;">
                                [% IF todo.status == 1 %]New
                                [% ELSIF todo.status == 2 %]In Progress
                                [% ELSIF todo.status == 3 %]Completed
                                [% ELSE %][% todo.status %]
                                [% END %]
                            </span>
                        </span>
                    </div>
                </div>
                
                <!-- Right side: Action buttons -->
                <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                    [% INCLUDE 'include/todo_actions.tt' 
                       todo = todo 
                       action_type = 'forms'
                       target = '_blank'
                       site_name = c.session.SiteName || 'default'
                       css_classes = 'todo-actions' %]
                </div>
            </div>
        </div>
        [% END %]
    </div>
</div>
[% END %]



<div class="feature-card">
    <div class="feature-header">
        <h3><i class="fas fa-filter"></i> Filter Options</h3>
    </div>
    <div class="feature-content">
        <form id="todo-filter-form" action="/todo" method="get">
            <div class="filter-row" style="display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px;">
                <div class="filter-group" style="flex: 1; min-width: 200px;">
                    <label for="filter" class="form-label">Time Filter:</label>
                    <select id="filter" name="filter" class="form-control">
                        <option value="all" [% IF filter_type == 'all' %]selected[% END %]>All Todos</option>
                        <option value="day" [% IF filter_type == 'day' %]selected[% END %]>Today's Todos</option>
                        <option value="week" [% IF filter_type == 'week' %]selected[% END %]>This Week's Todos</option>
                        <option value="month" [% IF filter_type == 'month' %]selected[% END %]>This Month's Todos</option>
                    </select>
                </div>

                <div class="filter-group" style="flex: 1; min-width: 200px;">
                    <label for="project_id" class="form-label">Project:</label>
                    <select id="project_id" name="project_id" class="form-control">
                        <option value="">All Projects</option>
                        [% IF projects && projects.size > 0 %]
                            [% FOREACH project IN projects %]
                                <option value="[% project.id %]" [% IF project_id == project.id %]selected[% END %]>[% project.name %]</option>
                                [% IF project.sub_projects && project.sub_projects.size > 0 %]
                                    [% FOREACH sub_project IN project.sub_projects %]
                                        <option value="[% sub_project.id %]" [% IF project_id == sub_project.id %]selected[% END %]>&nbsp;&nbsp;- [% sub_project.name %]</option>
                                        [% IF sub_project.sub_projects && sub_project.sub_projects.size > 0 %]
                                            [% FOREACH sub_sub_project IN sub_project.sub_projects %]
                                                <option value="[% sub_sub_project.id %]" [% IF project_id == sub_sub_project.id %]selected[% END %]>&nbsp;&nbsp;&nbsp;&nbsp;-- [% sub_sub_project.name %]</option>
                                            [% END %]
                                        [% END %]
                                    [% END %]
                                [% END %]
                            [% END %]
                        [% END %]
                    </select>
                </div>

                <div class="filter-group" style="flex: 1; min-width: 200px;">
                    <label for="status" class="form-label">Status:</label>
                    <select id="status" name="status" class="form-control">
                        <option value="" [% IF status_filter == '' %]selected[% END %]>Active Todos</option>
                        <option value="all" [% IF status_filter == 'all' %]selected[% END %]>All Statuses</option>
                        <option value="new" [% IF status_filter == 'new' %]selected[% END %]>New</option>
                        <option value="in_progress" [% IF status_filter == 'in_progress' %]selected[% END %]>In Progress</option>
                        <option value="completed" [% IF status_filter == 'completed' %]selected[% END %]>Completed</option>
                    </select>
                </div>

                <div class="filter-group" style="flex: 1; min-width: 200px;">
                    <label for="search" class="form-label">Search:</label>
                    <input type="text" id="search" name="search" class="form-control" placeholder="Search in subject, description, comments..." value="[% search_term %]">
                </div>
            </div>
        </form>
    </div>
    <div class="feature-actions">
        <button type="submit" class="btn btn-primary" form="todo-filter-form">Apply Filters</button>
        <button type="button" class="btn btn-secondary" onclick="window.location.href='/todo'">Reset Filters</button>
    </div>
</div>

<div class="feature-actions" style="margin-bottom: 20px;">
    <a href="/todo" class="btn btn-secondary [% IF !filter_type || filter_type == 'all' %]active[% END %]">
        <i class="fas fa-list"></i> List View
    </a>
    <a href="/todo/day" class="btn btn-secondary">
        <i class="fas fa-calendar-day"></i> Day View
    </a>
    <a href="/todo/week" class="btn btn-secondary">
        <i class="fas fa-calendar-week"></i> Week View
    </a>
    <a href="/todo/month" class="btn btn-secondary">
        <i class="fas fa-calendar"></i> Month View
    </a>
    <a href="/todo/ai_create" class="btn btn-info" title="Use AI to automatically create a new todo task">
        <i class="fas fa-robot"></i>
        <span class="ai-create-icon-text" data-site="[% c.session.SiteName || 'default' %]" title="AI-powered task creation">AI Create Todo</span>
    </a>
    <a href="/todo/addtodo" class="btn btn-success">
        <i class="fas fa-plus"></i> Add New Todo
    </a>
</div>
<!-- Todo List using Feature Cards -->
<div class="feature-grid" style="grid-template-columns: 1fr; gap: 15px;">
[% counter = 0 %]
[% FOREACH task IN todos %]
    [% IF counter % 5 == 0 AND counter != 0 %]
        <div class="feature-card">
            <div class="feature-actions">
                <button type="button" class="btn btn-secondary" onclick="window.scrollTo(0, 0);">
                    <i class="fas fa-arrow-up"></i> Return to top
                </button>
                <form action="/todo/addtodo" method="post" style="display: inline;">
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add New Record
                    </button>
                </form>
            </div>
        </div>
    [% END %]
    
    <div class="feature-card" data-todo-id="[% task.get_column('record_id') %]" data-site="[% task.get_column('sitename') || c.session.SiteName || 'default' %]">
        <div class="feature-header" style="cursor: pointer;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; width: 100%; gap: 15px;">
                <!-- Left side: Subject and meta info -->
                <div style="flex: 1; min-width: 0;" onclick="todoEnhancements.toggleTodoDetails('[% task.get_column('record_id') %]')">
                    <h4 style="margin: 0 0 8px 0; font-size: 1.1em; color: var(--text-color);">[% task.get_column('subject') %]</h4>
                    <div style="display: flex; flex-wrap: wrap; gap: 15px; font-size: 0.9em; color: var(--text-color);">
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <strong>Priority:</strong>
                            <span class="priority-badge" style="padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; background-color: [% IF task.get_column('priority') == 1 %]var(--warning-color)[% ELSIF task.get_column('priority') == 2 %]var(--accent-color)[% ELSE %]var(--success-color)[% END %]; color: white;">
                                <span class="priority-icon-text" data-site="[% task.get_column('sitename') || c.session.SiteName || 'default' %]" data-priority="[% task.get_column('priority') %]" title="Task priority level">
                                  [% IF task.get_column('priority') == 1 %]High
                                  [% ELSIF task.get_column('priority') == 2 %]Medium  
                                  [% ELSIF task.get_column('priority') == 3 %]Normal
                                  [% ELSE %][% task.get_column('priority') %]
                                  [% END %]
                                </span>
                            </span>
                        </span>
                        [% IF task.get_column('due_date') %]
                        <span><strong>Due:</strong> [% task.get_column('due_date') %]</span>
                        [% END %]
                        [% IF task.project %]
                        <span><strong>Project:</strong> [% task.project.name %]</span>
                        [% ELSIF task.get_column('project_id') %]
                        <span><strong>Project ID:</strong> [% task.get_column('project_id') %]</span>
                        [% END %]
                        <span style="display: flex; align-items: center; gap: 5px;">
                            <strong>Status:</strong>
                            <span class="status-badge" style="padding: 2px 6px; border-radius: 3px; font-size: 0.8em; font-weight: bold; text-transform: uppercase; background-color: [% IF task.get_column('status') == 1 %]var(--info-color)[% ELSIF task.get_column('status') == 2 %]var(--accent-color)[% ELSE %]var(--success-color)[% END %]; color: white;">
                                <span class="status-icon-text" data-site="[% task.get_column('sitename') || c.session.SiteName || 'default' %]" data-status="[% task.get_column('status') %]" title="Current task status">
                                  [% IF task.get_column('status') == 1 %]New
                                  [% ELSIF task.get_column('status') == 2 %]In Progress
                                  [% ELSIF task.get_column('status') == 3 %]Completed
                                  [% ELSE %][% task.get_column('status') %]
                                  [% END %]
                                </span>
                            </span>
                        </span>
                    </div>
                </div>
                
                <!-- Right side: Action buttons -->
                <div style="display: flex; align-items: center; gap: 8px; flex-shrink: 0;">
                    <div class="todo-actions" style="display: flex; gap: 5px; align-items: center;">
                        [% INCLUDE 'include/todo_actions.tt' 
                           todo = task 
                           action_type = 'forms'
                           target = '_blank'
                           site_name = task.get_column('sitename') || c.session.SiteName || 'default'
                           css_classes = 'todo-actions' %]
                    </div>
                    <span class="todo-expand-icon" id="todo-icon-[% task.get_column('record_id') %]" 
                          onclick="todoEnhancements.toggleTodoDetails('[% task.get_column('record_id') %]')"
                          style="transition: transform 0.3s ease; font-size: 1.2em; color: var(--text-color); cursor: pointer; margin-left: 5px;">&#9660;</span>
                </div>
            </div>
        </div>
        
        <div class="feature-content todo-details" id="todo-details-[% task.get_column('record_id') %]" style="display: none;">
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 15px;">
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Site Name</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('sitename') %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Project</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% IF task.project %][% task.project.name %][% ELSE %][% task.get_column('project_id') %][% END %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Parent Todo</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('parent_todo') %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Start Date</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('start_date') %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Due Date</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('due_date') %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Who is Responsible</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('developer') %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Code Needed For</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('comments') %]</div>
                </div>
                <div class="todo-field">
                    <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Accumulated Time</div>
                    <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('accumulative_time') %]</div>
                </div>
            </div>
            
            [% IF task.get_column('description') %]
            <div class="todo-field">
                <div style="font-weight: bold; color: var(--text-color); margin-bottom: 5px; font-size: 0.9em;">Details</div>
                <div style="color: var(--text-color); padding: 5px 0;">[% task.get_column('description') %]</div>
            </div>
            [% END %]
        </div>
    </div>
    [% counter = counter + 1 %]
[% END %]
</div>

<!-- Todo functional CSS and JavaScript -->
<link rel="stylesheet" href="/static/css/todo-functional.css">
<script src="/static/js/todo-enhancements.js"></script>

</div> <!-- Close apiary-container -->