
[% META title = 'Project Details' %]

[% MACRO display_project_details(project, level) BLOCK %]
    [% SET indent = '' %]
    [% FOREACH i IN [1..level] %]
        [% indent = indent _ '    ' %]
    [% END %]
    
    [% SET project_id = "project-" _ project.id %]
    [% SET details_id = "details-" _ project.id %]
    [% SET todos_id = "todos-" _ project.id %]

    <div class="project-details level-[% level %]" style="margin-left: [% level * 30 %]px;">
        <div class="project-header [% IF level > 0 %]sub-project-header-level-[% level %][% ELSE %]main-project-header[% END %]">
            <span class="expand-collapse" onclick="toggleElement('[% details_id %]')">
                <i class="toggle-icon" id="toggle-[% details_id %]">▼</i>
            </span>
            <h[% level + 1 %] class="project-title">
                [% IF level > 0 %]Sub-Project: [% END %][% project.name %]
                <span class="project-status">[% project.status %]</span>
            </h[% level + 1 %]>
            
            [% IF project.todos.size %]
            <span class="todo-count" onclick="toggleElement('[% todos_id %]')">
                <span class="badge">[% project.todos.size %] Todos</span>
            </span>
            [% END %]
        </div>
        
        <div id="[% details_id %]" class="collapsible">
            <ul class="project-info">
                <li><strong>Description:</strong> [% project.description OR 'No description' %]</li>
                <li><strong>Timeline:</strong> [% project.start_date %] to [% project.end_date %]</li>
                <li><strong>Project Code:</strong> [% project.project_code %]</li>
                <li><strong>Size/Effort:</strong> [% project.project_size %] / [% project.estimated_man_hours %] hours</li>
                <li><strong>Team:</strong> [% project.developer_name %] (Developer), [% project.client_name %] (Client)</li>
            </ul>

            [% IF project.todos.size %]
            <div class="todos-container">
                <h[% level + 2 %] class="todos-header" onclick="toggleElement('[% todos_id %]')">
                    <span class="expand-collapse">
                        <i class="toggle-icon" id="toggle-[% todos_id %]">▼</i>
                    </span>
                    Todos for [% project.name %]
                </h[% level + 2 %]>
                
                <div id="[% todos_id %]" class="collapsible">
                    <table class="project-details-table">
                        <thead>
                            <tr>
                                <th>Subject</th>
                                <th>Description</th>
                                <th>Timeline</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Time</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            [% FOREACH todo IN project.todos %]
                            <tr class="todo-row [% todo.status | lower %]-status">
                                <td>[% todo.subject %]</td>
                                <td>[% todo.description OR 'No description' %]</td>
                                <td>[% todo.start_date %] - [% todo.due_date %]</td>
                                <td><span class="status-badge [% todo.status | lower %]">[% todo.status %]</span></td>
                                <td><span class="priority-badge [% todo.priority | lower %]">[% todo.priority %]</span></td>
                                <td>[% todo.formatted_accumulated_time %]</td>
                                <td>
                                    <form action="/todo/modify/[% todo.record_id %]" method="GET" style="display:inline;">
                                        <button type="submit" class="action-button">Edit</button>
                                    </form>
                                </td>
                            </tr>
                            [% END %]
                        </tbody>
                    </table>
                </div>
            </div>
            [% END %]

            <!-- Actions for this project level -->
            <div class="project-actions">
                <form action="/project/editproject" method="POST" style="display:inline;">
                    <input type="hidden" name="project_id" value="[% project.id %]">
                    <button type="submit" class="action-button edit">Edit [% IF level > 0 %]Sub-[% END %]Project</button>
                </form>
                
                <form action="/project/addproject" method="GET" style="display:inline;">
                    <input type="hidden" name="parent_id" value="[% project.id %]">
                    <button type="submit" class="action-button add">Add Sub-Project</button>
                </form>
                
                <form action="/todo/addtodo" method="GET" style="display:inline;">
                    <input type="hidden" name="project_id" value="[% project.id %]">
                    <button type="submit" class="action-button add">Add Todo</button>
                </form>
            </div>
        </div>

        [% IF project.sub_projects.size %]
            <div class="sub-projects-container">
                [% FOREACH sub_project IN project.sub_projects %]
                    [% display_project_details(sub_project, level + 1) %]
                [% END %]
            </div>
        [% END %]
    </div>
[% END %]

[% PageVersion = 'todo/projectdetails.tt,v 0.02 2024/03/15 shanta Exp shanta ' %]
[% IF debug_mode == 1 %]
    [% PageVersion %]
[% END %]

<div class="project-container">
    <!-- Display the main project and all its sub-projects recursively -->
    [% display_project_details(project, 0) %]
</div>

<!-- Display total accumulated time for all projects -->
<h3>Total Accumulated Time for All Projects: [% total_accumulated_time %]</h3>

<!-- Button to go back to the project list -->
<button type="button" onclick="window.location.href='/project';" class="action-button back">Back to Projects</button>

<!-- JavaScript for expand/collapse functionality -->
<script>
function toggleElement(elementId) {
    const element = document.getElementById(elementId);
    const toggleIcon = document.getElementById('toggle-' + elementId);
    
    if (element.style.display === 'none') {
        element.style.display = 'block';
        toggleIcon.innerHTML = '▼';
    } else {
        element.style.display = 'none';
        toggleIcon.innerHTML = '►';
    }
}

// Initialize all collapsible elements
document.addEventListener('DOMContentLoaded', function() {
    // Collapse all todo sections by default
    const todoSections = document.querySelectorAll('[id^="todos-"]');
    todoSections.forEach(function(section) {
        section.style.display = 'none';
        const toggleIcon = document.getElementById('toggle-' + section.id);
        if (toggleIcon) toggleIcon.innerHTML = '►';
    });
    
    // Keep project details expanded for the main project, collapse for sub-projects
    const detailSections = document.querySelectorAll('[id^="details-"]');
    detailSections.forEach(function(section) {
        // If it's not the main project, collapse it
        if (section.closest('.level-0') === null) {
            section.style.display = 'none';
            const toggleIcon = document.getElementById('toggle-' + section.id);
            if (toggleIcon) toggleIcon.innerHTML = '►';
        }
    });
});
</script>

<!-- Add enhanced styling -->
<style>
.project-container {
    font-family: Arial, sans-serif;
    max-width: 1200px;
    margin: 0 auto;
}

.project-details {
    border-left: 4px solid #ccc;
    margin: 15px 0;
    padding: 0;
    border-radius: 4px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    background-color: #fff;
}

/* Different colors for different nesting levels */
.level-0 {
    border-left-color: #3498db;
}

.level-1 {
    border-left-color: #2ecc71;
}

.level-2 {
    border-left-color: #e74c3c;
}

.level-3 {
    border-left-color: #f39c12;
}

.level-4 {
    border-left-color: #9b59b6;
}

.project-header {
    padding: 10px 15px;
    cursor: pointer;
    display: flex;
    align-items: center;
    border-bottom: 1px solid #eee;
}

.main-project-header {
    background-color: #3498db;
    color: white;
}

.sub-project-header-level-1 {
    background-color: #2ecc71;
    color: white;
}

.sub-project-header-level-2 {
    background-color: #e74c3c;
    color: white;
}

.sub-project-header-level-3 {
    background-color: #f39c12;
    color: white;
}

.sub-project-header-level-4 {
    background-color: #9b59b6;
    color: white;
}

.project-title {
    margin: 0;
    flex-grow: 1;
    font-size: 1.2em;
}

.project-status {
    font-size: 0.7em;
    background-color: rgba(255,255,255,0.3);
    padding: 3px 8px;
    border-radius: 10px;
    margin-left: 10px;
    font-weight: normal;
}

.expand-collapse {
    margin-right: 10px;
    font-size: 1.2em;
    cursor: pointer;
}

.toggle-icon {
    display: inline-block;
    width: 20px;
    text-align: center;
    font-style: normal;
}

.todo-count {
    margin-left: auto;
    cursor: pointer;
}

.badge {
    background-color: rgba(255,255,255,0.3);
    padding: 3px 8px;
    border-radius: 10px;
    font-size: 0.8em;
}

.collapsible {
    padding: 15px;
    background-color: #f9f9f9;
}

.project-info {
    list-style-type: none;
    padding: 0;
    margin: 0 0 15px 0;
}

.project-info li {
    padding: 5px 0;
    border-bottom: 1px solid #eee;
}

.project-info li:last-child {
    border-bottom: none;
}

.todos-header {
    margin: 10px 0;
    padding: 8px;
    background-color: #f5f5f5;
    border-radius: 4px;
    cursor: pointer;
    display: flex;
    align-items: center;
}

.project-details-table {
    width: 100%;
    border-collapse: collapse;
    margin: 10px 0;
    background-color: white;
}

.project-details-table th,
.project-details-table td {
    border: 1px solid #ddd;
    padding: 8px;
    text-align: left;
}

.project-details-table th {
    background-color: #f5f5f5;
    position: sticky;
    top: 0;
}

.todo-row:hover {
    background-color: #f5f5f5;
}

.status-badge, .priority-badge {
    display: inline-block;
    padding: 3px 8px;
    border-radius: 3px;
    font-size: 0.8em;
    text-align: center;
    color: white;
}

/* Status colors */
.requested {
    background-color: #3498db;
}

.in-process {
    background-color: #f39c12;
}

.testing {
    background-color: #9b59b6;
}

.delivered {
    background-color: #2ecc71;
}

/* Priority colors */
.high {
    background-color: #e74c3c;
}

.medium {
    background-color: #f39c12;
}

.low {
    background-color: #3498db;
}

.project-actions {
    margin: 15px 0 0 0;
    padding: 10px;
    background: #f5f5f5;
    border-radius: 4px;
    display: flex;
    flex-wrap: wrap;
}

.project-actions form {
    margin-right: 10px;
    margin-bottom: 5px;
}

.action-button {
    padding: 6px 12px;
    border: none;
    border-radius: 4px;
    cursor: pointer;
    font-size: 0.9em;
    transition: background-color 0.3s;
}

.action-button:hover {
    opacity: 0.9;
}

.action-button.edit {
    background-color: #3498db;
    color: white;
}

.action-button.add {
    background-color: #2ecc71;
    color: white;
}

.action-button.back {
    background-color: #7f8c8d;
    color: white;
    padding: 8px 16px;
    font-size: 1em;
    margin-top: 20px;
}

/* Responsive adjustments */
@media (max-width: 768px) {
    .project-details {
        margin-left: 10px !important;
    }
    
    .project-details-table {
        display: block;
        overflow-x: auto;
    }
}
</style>