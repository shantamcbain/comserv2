[% PageVersion = 'Documentation/api_credentials.tt,v 1.1 2025/06/15 shanta Exp shanta ' %]
[% IF c.session.debug_mode == 1 %]
    [% PageVersion %]
[% END %]

[% META 
   title = "API Credentials Management"
   description = "Documentation for managing API credentials in the Comserv system"
   roles = "admin,developer"
   category = "admin_guides"
%]

<div class="documentation-container">
    <h1>API Credentials Management</h1>
    
    <div class="toc">
        <h2>Table of Contents</h2>
        <ul>
            <li><a href="#overview">Overview</a></li>
            <li><a href="#credential-storage">Credential Storage</a></li>
            <li><a href="#supported-services">Supported Services</a>
                <ul>
                    <li><a href="#virtualmin">Virtualmin</a></li>
                    <li><a href="#cloudflare">Cloudflare</a></li>
                    <li><a href="#opnsense">OPNsense</a></li>
                    <li><a href="#proxmox">Proxmox</a></li>
                    <li><a href="#stripe">Stripe</a></li>
                    <li><a href="#mailchimp">Mailchimp</a></li>
                    <li><a href="#twilio">Twilio</a></li>
                </ul>
            </li>
            <li><a href="#adding-new-services">Adding New Services</a></li>
            <li><a href="#security-considerations">Security Considerations</a></li>
            <li><a href="#troubleshooting">Troubleshooting</a></li>
            <li><a href="#best-practices">Best Practices</a></li>
            <li><a href="#related-documentation">Related Documentation</a></li>
        </ul>
    </div>
    
    <section id="overview">
        <h2>Overview</h2>
        <p>The API Credentials Management system provides a secure way to store and manage authentication credentials for various external services used by the Comserv application. This document explains how the system works, how to configure credentials, and best practices for credential management.</p>
        
        <div class="admin-action">
            <p><strong>Administrator Action:</strong> You can manage these credentials through the <a href="[% c.uri_for('/ApiCredentials') %]">API Credentials Management</a> interface.</p>
        </div>
    </section>
    
    <section id="credential-storage">
        <h2>Credential Storage</h2>
        <p>API credentials are stored in a JSON file located at:</p>
        
        <pre>
/home/shanta/PycharmProjects/comserv2/Comserv/config/api_credentials.json
        </pre>
        
        <p>This file is not included in version control to prevent accidental exposure of sensitive information. The file is structured as follows:</p>
        
        <pre>
{
  "virtualmin": {
    "host": "virtualmin.example.com",
    "username": "admin",
    "password": "secure_password"
  },
  "cloudflare": {
    "api_token": "your_api_token",
    "zone_id": "your_zone_id",
    "email": "admin@example.com"
  },
  "opnsense": {
    "host": "firewall.example.com",
    "api_key": "your_api_key",
    "api_secret": "your_api_secret"
  }
}
        </pre>
    </section>
    
    <section id="supported-services">
        <h2>Supported Services</h2>
        <p>The following services are currently supported:</p>
        
        <h3 id="virtualmin">Virtualmin</h3>
        <p>Virtualmin is a web hosting control panel used for managing virtual hosts, domains, and web servers.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>host</code>: The hostname or IP address of your Virtualmin server</li>
            <li><code>username</code>: The administrative username for Virtualmin access</li>
            <li><code>password</code>: The password for the administrative user</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>Server provisioning</li>
            <li>Domain management</li>
            <li>Backup systems</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Log in to your Virtualmin server as an administrator</li>
            <li>Navigate to System Settings → Webmin Users</li>
            <li>Create a new user with appropriate permissions or use an existing admin account</li>
            <li>Note the server hostname, username, and password</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://www.virtualmin.com/documentation/developer/http-api/" target="_blank">Virtualmin API Documentation</a></li>
            <li><a href="https://www.virtualmin.com/documentation/developer/http-api/authentication/" target="_blank">Virtualmin API Authentication Guide</a></li>
        </ul>
        
        <h3 id="cloudflare">Cloudflare</h3>
        <p>Cloudflare provides CDN, DNS, and security services.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>api_token</code>: API token generated from the Cloudflare dashboard</li>
            <li><code>zone_id</code>: The Zone ID for your domain</li>
            <li><code>email</code>: Email address associated with your Cloudflare account</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>DNS management</li>
            <li>SSL certificate provisioning</li>
            <li>Security modules</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Log in to your Cloudflare dashboard</li>
            <li>Navigate to My Profile → API Tokens</li>
            <li>Create a new API token with appropriate permissions</li>
            <li>To find your Zone ID, go to the domain overview page and look in the right sidebar under "API"</li>
            <li>Use the email address associated with your Cloudflare account</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://developers.cloudflare.com/api/" target="_blank">Cloudflare API Documentation</a></li>
            <li><a href="https://developers.cloudflare.com/fundamentals/api/get-started/create-token/" target="_blank">Creating API Tokens in Cloudflare</a></li>
            <li><a href="https://developers.cloudflare.com/fundamentals/get-started/basic-tasks/find-account-and-zone-ids/" target="_blank">Finding Zone IDs in Cloudflare</a></li>
        </ul>
        
        <h3 id="opnsense">OPNsense</h3>
        <p>OPNsense is an open-source firewall and routing platform.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>host</code>: The hostname or IP address of your OPNsense firewall</li>
            <li><code>api_key</code>: The API key created in the OPNsense dashboard</li>
            <li><code>api_secret</code>: The API secret associated with your API key</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>Network management</li>
            <li>Firewall configuration</li>
            <li>VPN setup modules</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Log in to your OPNsense firewall web interface</li>
            <li>Navigate to System → Access → Users</li>
            <li>Edit a user or create a new one</li>
            <li>Go to the API section and check "Allow API keys for this user"</li>
            <li>Click the "+" button to generate a new key</li>
            <li>Save both the API key and API secret shown</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://docs.opnsense.org/development/api.html" target="_blank">OPNsense API Documentation</a></li>
            <li><a href="https://docs.opnsense.org/development/how-tos/api.html" target="_blank">OPNsense API How-To Guide</a></li>
        </ul>
        
        <h3 id="proxmox">Proxmox</h3>
        <p>Proxmox is a virtualization platform for managing VMs and containers.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>host</code>: The hostname or IP address of your Proxmox server</li>
            <li><code>username</code>: Username with API access permissions (format: user@pam or user@pve)</li>
            <li><code>password</code>: Password for the Proxmox user</li>
            <li><code>token_name</code> (optional): API token name (if using token authentication)</li>
            <li><code>token_value</code> (optional): API token value (if using token authentication)</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>VM provisioning</li>
            <li>Container management</li>
            <li>Resource monitoring</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Log in to your Proxmox web interface</li>
            <li>Navigate to Datacenter → Permissions → API Tokens</li>
            <li>Click "Add" to create a new API token</li>
            <li>Select a user and enter a token ID (this will be your token_name)</li>
            <li>Decide whether to restrict the token privileges</li>
            <li>Click "Create" and save both the token ID and secret (token_value)</li>
            <li>Alternatively, you can use username/password authentication with a user that has appropriate permissions</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://pve.proxmox.com/wiki/Proxmox_VE_API" target="_blank">Proxmox API Documentation</a></li>
            <li><a href="https://pve.proxmox.com/wiki/Proxmox_VE_API#Authentication" target="_blank">Proxmox API Authentication Guide</a></li>
            <li><a href="https://pve.proxmox.com/wiki/Proxmox_VE_API#API_Tokens" target="_blank">Proxmox API Tokens Guide</a></li>
        </ul>
        
        <h3 id="stripe">Stripe</h3>
        <p>Stripe is a payment processing platform for online businesses.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>publishable_key</code>: Stripe publishable key for client-side integration</li>
            <li><code>secret_key</code>: Stripe secret key for server-side API calls</li>
            <li><code>webhook_secret</code>: Secret for validating webhook signatures</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>Payment processing</li>
            <li>Subscription management</li>
            <li>Billing modules</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Create or log in to your Stripe account at <a href="https://dashboard.stripe.com/" target="_blank">https://dashboard.stripe.com/</a></li>
            <li>Navigate to Developers → API keys</li>
            <li>You'll see your publishable key and can reveal your secret key</li>
            <li>For webhook secrets, go to Developers → Webhooks</li>
            <li>Create a new webhook endpoint or click on an existing one</li>
            <li>Find the "Signing secret" section to reveal or create your webhook secret</li>
            <li>Make sure to use test keys for development and live keys for production</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://stripe.com/docs/api" target="_blank">Stripe API Documentation</a></li>
            <li><a href="https://stripe.com/docs/keys" target="_blank">Stripe API Keys Guide</a></li>
            <li><a href="https://stripe.com/docs/webhooks" target="_blank">Stripe Webhooks Guide</a></li>
        </ul>
        
        <h3 id="mailchimp">Mailchimp</h3>
        <p>Mailchimp is an email marketing platform for managing mailing lists and campaigns.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>api_key</code>: The API key for your Mailchimp account</li>
            <li><code>server_prefix</code>: The server prefix (e.g., "us1") for your Mailchimp account</li>
            <li><code>list_id</code>: The ID of the mailing list you want to work with</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>Newsletter management</li>
            <li>Email campaigns</li>
            <li>Subscriber tracking</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Log in to your Mailchimp account</li>
            <li>Click on your profile name to open the Account Panel</li>
            <li>Select "Account & Billing"</li>
            <li>Navigate to "Extras" → "API keys"</li>
            <li>Generate a new API key or use an existing one</li>
            <li>The server prefix is the part after the dash in your Mailchimp URL (e.g., "us1" in "login.mailchimp.com/us1")</li>
            <li>To find a list ID, go to Audience → Settings → Audience name and defaults</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://mailchimp.com/developer/marketing/api/root/" target="_blank">Mailchimp API Documentation</a></li>
            <li><a href="https://mailchimp.com/developer/marketing/guides/quick-start/" target="_blank">Mailchimp API Quick Start Guide</a></li>
        </ul>
        
        <h3 id="twilio">Twilio</h3>
        <p>Twilio provides communication APIs for SMS, voice, and video.</p>
        
        <p><strong>Required Credentials:</strong></p>
        <ul>
            <li><code>account_sid</code>: Your Twilio account identifier</li>
            <li><code>auth_token</code>: Your Twilio authentication token</li>
            <li><code>phone_number</code>: Your Twilio phone number (with country code)</li>
        </ul>
        
        <p><strong>Used By:</strong></p>
        <ul>
            <li>SMS notifications</li>
            <li>Voice calls</li>
            <li>Two-factor authentication</li>
        </ul>
        
        <p><strong>How to Obtain Credentials:</strong></p>
        <ol>
            <li>Create or log in to your Twilio account at <a href="https://www.twilio.com/console" target="_blank">https://www.twilio.com/console</a></li>
            <li>Your Account SID and Auth Token are displayed on the dashboard</li>
            <li>To get a phone number, navigate to Phone Numbers → Manage → Active numbers</li>
            <li>Purchase a new number if you don't have one already</li>
            <li>Make sure to use test credentials for development and live credentials for production</li>
        </ol>
        
        <p><strong>Documentation:</strong></p>
        <ul>
            <li><a href="https://www.twilio.com/docs/api" target="_blank">Twilio API Documentation</a></li>
            <li><a href="https://www.twilio.com/docs/sms/quickstart" target="_blank">Twilio SMS Quickstart Guide</a></li>
            <li><a href="https://www.twilio.com/docs/voice/quickstart" target="_blank">Twilio Voice Quickstart Guide</a></li>
        </ul>
    </section>
    
    <section id="adding-new-services">
        <h2>Adding New Services</h2>
        <p>To add support for a new API service:</p>
        
        <ol>
            <li>Add the service credentials to the <code>api_credentials.json</code> file</li>
            <li>Update the template to include descriptions for the new service</li>
            <li>Implement the API client in the appropriate module</li>
        </ol>
    </section>
    
    <section id="security-considerations">
        <h2>Security Considerations</h2>
        
        <h3>Access Control</h3>
        <ul>
            <li>Only administrators can access and modify API credentials</li>
            <li>All access attempts are logged for security auditing</li>
            <li>Failed access attempts trigger security notifications</li>
        </ul>
        
        <h3>Credential Storage</h3>
        <ul>
            <li>Credentials are stored in a JSON file outside of version control</li>
            <li>The file permissions are set to restrict access to the web server user only</li>
            <li>Sensitive fields (passwords, tokens, keys) are masked in the UI by default</li>
        </ul>
        
        <h3>API Usage</h3>
        <ul>
            <li>All API requests are logged for auditing purposes</li>
            <li>API requests use HTTPS for secure communication</li>
            <li>Rate limiting is implemented to prevent abuse</li>
        </ul>
        
        <div class="note-box">
            <strong>Important:</strong> The <code>api_credentials.json</code> file should have restricted permissions (e.g., 600) to prevent unauthorized access.
        </div>
    </section>
    
    <section id="troubleshooting">
        <h2>Troubleshooting</h2>
        
        <h3>Common Issues</h3>
        <dl>
            <dt>1. API Requests Failing</dt>
            <dd>
                <ul>
                    <li>Verify that the credentials are correct and up-to-date</li>
                    <li>Check that the external service is operational</li>
                    <li>Ensure that the API permissions are correctly configured</li>
                </ul>
            </dd>
            
            <dt>2. Permission Denied</dt>
            <dd>
                <ul>
                    <li>Verify that the user has administrator privileges</li>
                    <li>Check the file permissions on the credentials file</li>
                    <li>Review the application logs for access issues</li>
                </ul>
            </dd>
            
            <dt>3. Credentials Not Saving</dt>
            <dd>
                <ul>
                    <li>Ensure the config directory is writable by the web server</li>
                    <li>Check for JSON syntax errors in the credentials file</li>
                    <li>Review the application logs for file writing errors</li>
                </ul>
            </dd>
        </dl>
        
        <h3>Logging</h3>
        <p>API credential usage and changes are logged in the application log file. Look for entries with the following prefixes:</p>
        <ul>
            <li><code>ApiCredentials controller</code>: General controller actions</li>
            <li><code>_load_credentials</code>: Loading credential operations</li>
            <li><code>_save_credentials</code>: Saving credential operations</li>
        </ul>
    </section>
    
    <section id="best-practices">
        <h2>Best Practices</h2>
        
        <h3>1. Regular Rotation</h3>
        <ul>
            <li>Rotate API keys and tokens regularly (every 90 days recommended)</li>
            <li>Update the credentials immediately after staff changes</li>
        </ul>
        
        <h3>2. Least Privilege</h3>
        <ul>
            <li>Use API tokens with the minimum required permissions</li>
            <li>Create service-specific API keys rather than using master keys</li>
        </ul>
        
        <h3>3. Monitoring</h3>
        <ul>
            <li>Regularly review the API usage logs</li>
            <li>Set up alerts for unusual API activity</li>
            <li>Monitor for failed authentication attempts</li>
        </ul>
        
        <h3>4. Documentation</h3>
        <ul>
            <li>Document all API integrations and their credential requirements</li>
            <li>Keep a secure inventory of which services are using which credentials</li>
            <li>Document the process for rotating credentials</li>
        </ul>
    </section>
    
    <section id="related-documentation">
        <h2>Related Documentation</h2>
        <ul>
            <li><a href="[% c.uri_for('/Documentation/api') %]">API Documentation</a> - General API documentation</li>
            <li><a href="[% c.uri_for('/Documentation/virtualmin') %]">Virtualmin Integration</a> - Details on Virtualmin integration</li>
            <li><a href="[% c.uri_for('/Documentation/cloudflare') %]">Cloudflare Integration</a> - Details on Cloudflare integration</li>
            <li><a href="[% c.uri_for('/Documentation/opnsense') %]">OPNsense Integration</a> - Details on OPNsense integration</li>
            <li><a href="[% c.uri_for('/Documentation/proxmox') %]">Proxmox Integration</a> - Details on Proxmox integration</li>
        </ul>
    </section>
</div>

<style>
    .documentation-container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .toc {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 30px;
    }
    
    .toc ul {
        list-style-type: none;
        padding-left: 20px;
    }
    
    section {
        margin-bottom: 40px;
    }
    
    pre {
        background-color: #f5f5f5;
        padding: 15px;
        border-radius: 5px;
        overflow-x: auto;
    }
    
    dt {
        font-weight: bold;
        margin-top: 15px;
    }
    
    dd {
        margin-left: 20px;
    }
    
    .admin-action {
        background-color: #e3f2fd;
        border: 1px solid #b3d7ff;
        border-radius: 4px;
        padding: 15px;
        margin: 20px 0;
    }
    
    .note-box {
        background-color: #fff3cd;
        border: 1px solid #ffeeba;
        color: #856404;
        padding: 15px;
        border-radius: 4px;
        margin: 15px 0;
    }
</style>