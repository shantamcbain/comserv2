[% PageVersion = 'Comserv/root/Documentation/changelog/2025-05-12-fix-documentation-controller-logging.tt,v 0.01 2025/06/10 shanta Exp shanta ' %]
[% IF c.session.debug_mode == 1 %]
    [% PageVersion %]
[% END %]

[% META title = 'Fix for Documentation Controller Logging' %]

<!-- Documentation page for 2025-05-12-fix-documentation-controller-logging -->
<div class="documentation-content">




<!-- Documentation CSS is now included in the theme system -->

<div class="markdown-content">


**File:** /home/shanta/PycharmProjects/comserv2/Comserv/root/Documentation/changelog/2025-05-12-fix-documentation-controller-logging.md  

**Date:** May 12, 2025  

**Author:** System Administrator  

**Status:** Implemented



<h2>Overview</h2>



This document addresses the issue of various log files being created in the Comserv directory each time the application processes documentation. These files included "Formatting title from", "Formatted title result", "Categorized as controller", "Category ... has ... pages", and other similar files. The problem was identified in the <code>log_to_file</code> method of the Logging module, which was creating files with the message as the filename when no file path was provided.



<h2>Issue Description</h2>



The root cause of the issue was in the <code>log_to_file</code> method in the <code>Comserv::Util::Logging</code> module. When this method was called without a file path (or with an undefined file path), it was creating a new file with the message as the filename:



<code></code>`perl

sub log_to_file {

    my ($message, $file_path, $level) = @_;

    $file_path //= $LOG_FILE || File::Spec->catfile($FindBin::Bin, '..', 'logs', 'application.log');

    $level    //= 'INFO';



    # ... rest of the method ...

    

    my $file;

    unless (open $file, '>>', $file_path) {

        _print_log("Failed to open file: $file_path\n");

        return;

    }

    

    # ... rest of the method ...

}

<code></code>`



The issue was that when <code>$file_path</code> was undefined and <code>$LOG_FILE</code> was also undefined (which could happen during initialization), the method would try to use <code>File::Spec->catfile($FindBin::Bin, '..', 'logs', 'application.log')</code>. However, if <code>$FindBin::Bin</code> didn't resolve correctly, this would result in creating a file with the message as the filename in the current directory.



Additionally, there were no checks to ensure that the file path was valid. If the file path was not a valid path (e.g., it was just a string like "Added ... to ... category"), the method would create a file with that name in the current directory.



This affected multiple parts of the code:



<ol><li>The Documentation controller's <code>_format_title</code> method was creating files like "Formatted title result: Overview"</li></ol>

<ol><li>The ScanMethods module was creating files like "Categorized as controller: HelpDesk" and "Category All Documentation has 193 pages"</li></ol>

<ol><li>The ScanMethods module was also creating files like "Added Documentation_Management to admin_guides category"</li></ol>



<h2>Solution</h2>



A comprehensive solution has been implemented:



<ol><li>**Fix for the Logging Module**: The <code>log_to_file</code> method in the <code>Comserv::Util::Logging</code> module has been modified to ensure it always uses a proper log file path, even when none is provided. This prevents the creation of files with the message as the filename.</li></ol>



<ol><li>**Fix for the Documentation Controller**: The <code>_format_title</code> method in the Documentation controller has been modified to use the standard <code>log_with_details</code> method instead of <code>log_to_file</code> with a specific path.</li></ol>



<ol><li>**Cleanup Script**: A script (<code>cleanup_formatting_title_files.sh</code>) has been created to remove any existing log files from the Comserv directory.</li></ol>



<h2>Implementation Details</h2>



<h3>Logging Module Fix</h3>



The <code>log_to_file</code> method in the <code>Comserv::Util::Logging</code> module has been modified to:



<code></code>`perl

sub log_to_file {

    my ($message, $file_path, $level) = @_;

    

    # CRITICAL FIX: Ensure we always use a proper log file path

    # If no file_path is provided or it's undefined, use the global log file

    # This prevents creating files with the message as the filename

    if (!defined $file_path || $file_path eq '') {

        # Use the global log file if it's defined, otherwise create a default path

        $file_path = $LOG_FILE;

        

        # If global log file is not defined yet, create a default path

        if (!defined $file_path) {

            my $log_dir = $ENV{'COMSERV_LOG_DIR'} 

                ? $ENV{'COMSERV_LOG_DIR'} 

                : File::Spec->catdir($FindBin::Bin, '..', 'logs');

                

            # Create the log directory if it doesn't exist

            unless (-d $log_dir) {

                eval { make_path($log_dir) };

                if ($@) {

                    _print_log("[ERROR] Failed to create log directory $log_dir: $@");

                    return;

                }

            }

            

            $file_path = File::Spec->catfile($log_dir, 'application.log');

        }

    }

    

    # CRITICAL FIX: Check if the file path is a directory

    if (-d $file_path) {

        _print_log("ERROR: File path is a directory: $file_path");

        

        # Use a default log file instead

        $file_path = File::Spec->catfile($ENV{'COMSERV_LOG_DIR'} || 

            File::Spec->catdir($FindBin::Bin, '..', 'logs'), 'application.log');

    }

    

    # CRITICAL FIX: Check if the file path contains invalid characters

    if ($file_path =~ /[\n\r]/) {

        _print_log("ERROR: File path contains invalid characters: $file_path");

        

        # Use a default log file instead

        $file_path = File::Spec->catfile($ENV{'COMSERV_LOG_DIR'} || 

            File::Spec->catdir($FindBin::Bin, '..', 'logs'), 'application.log');

    }

    

    # CRITICAL FIX: Ensure the file path is a valid file path

    # If it doesn't contain a directory separator, it's probably not a valid file path

    if ($file_path !~ /[\/\\]/) {

        _print_log("ERROR: File path does not appear to be a valid path: $file_path");

        

        # Use a default log file instead

        $file_path = File::Spec->catfile($ENV{'COMSERV_LOG_DIR'} || 

            File::Spec->catdir($FindBin::Bin, '..', 'logs'), 'application.log');

    }

    

    # ... rest of the method ...

}

<code></code>`



This ensures that all log messages are properly written to the application log file, even when no file path is provided. It also includes additional checks to ensure that the file path is valid and not a directory.



<h3>Documentation Controller Fix</h3>



The <code>_format_title</code> method in the Documentation controller has been modified to:



<code></code>`perl

$self->logging->log_with_details(undef, 'debug', __FILE__, __LINE__, '_format_title',

    "Formatting title from: $page_name");

<code></code>`



This ensures that logs are properly written to the application log file using the standard logging mechanism.



<h3>ScanMethods Module Fix</h3>



All calls to <code>log_to_file</code> in the ScanMethods module have been updated to use the application log file path:



<code></code>`perl

Comserv::Util::Logging::log_to_file("Categorizing documentation pages", $APP_LOG_FILE, 'INFO');

<code></code>`



<h3>Cleanup Script</h3>



The cleanup script performs the following actions:



<ol><li>Finds all log-like files in the Comserv directory, including:</li></ol>

   - "Formatting title from" files

   - "Formatted title result" files

   - "Categorized as controller" files

   - "Categorized as model" files

   - "Category ... has ... pages" files

   - "Starting Documentation" files

   - "Documentation system initialized" files

   - "Added ... to ... category" files

<ol><li>Logs the list of files to be removed</li></ol>

<ol><li>Deletes the files</li></ol>

<ol><li>Creates a log file with details of the operation</li></ol>



The script successfully removed 115 unwanted files from the Comserv directory.



<h2>Benefits</h2>



This solution provides several benefits:



<ol><li>**Cleaner Comserv Directory**: The Comserv directory is no longer cluttered with debug log files</li></ol>

<ol><li>**Proper Logging**: Debug messages are now properly written to the application log file</li></ol>

<ol><li>**Better Debugging**: All debug messages are now in one place, making it easier to debug issues</li></ol>

<ol><li>**Improved Performance**: The system no longer creates unnecessary files, improving performance</li></ol>

<ol><li>**Robust Logging**: The logging system now handles undefined file paths correctly</li></ol>



<h2>Next Steps</h2>



After implementing this fix, the following steps should be taken:



<ol><li>**Review Other Logging Calls**: Review other calls to <code>log_to_file</code> to ensure they are using the method correctly</li></ol>

<ol><li>**Update Logging Documentation**: Update the documentation for the logging system to clarify how to use it properly</li></ol>

<ol><li>**Consider Log Rotation**: Implement or review log rotation to prevent the application log from growing too large</li></ol>

<ol><li>**Add Monitoring**: Consider adding monitoring to detect if these files start appearing again</li></ol>



<h2>Related Documentation</h2>



<ul><li><a href="/Documentation/controllers/Documentation">Documentation Controller</a></li></ul>

<ul><li><a href="/Documentation/developer/logging_system">Logging System</a></li></ul>

<ul><li><a href="/Documentation/documentation_system_overview">Documentation System</a></li></ul>

</div>
