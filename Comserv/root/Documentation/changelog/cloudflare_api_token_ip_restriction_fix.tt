[% PageVersion = 'Documentation/changelog/cloudflare_api_token_ip_restriction_fix.tt,v 1.0 2025/07/15 shanta Exp shanta ' %]
[% IF c.session.debug_mode == 1 %]
    [% PageVersion %]
[% END %]

[% META title = 'Cloudflare API Token IP Restriction Fix' %]

<div class="changelog-entry">
    <h1>Cloudflare API Token IP Restriction Fix</h1>
    
    <div class="changelog-metadata">
        <p><strong>Date:</strong> July 15, 2025</p>
        <p><strong>Author:</strong> System Administrator</p>
        <p><strong>Type:</strong> Bug Fix</p>
    </div>
    
    <section id="overview">
        <h2>Overview</h2>
        <p>This update addresses an issue with the Cloudflare API integration where API requests were failing with 401 Unauthorized or 403 Forbidden errors due to IP restrictions on the API token.</p>
    </section>
    
    <section id="changes">
        <h2>Changes</h2>
        
        <h3>1. Enhanced Error Handling</h3>
        <ul>
            <li>Improved error messages for authentication failures</li>
            <li>Added specific handling for IP restriction errors (code 9109)</li>
            <li>Added more detailed logging for API token validation</li>
        </ul>
        
        <h3>2. Token Validation Improvements</h3>
        <ul>
            <li>Added checks for non-printable characters in API tokens</li>
            <li>Improved token format validation</li>
            <li>Enhanced debugging information for token-related issues</li>
        </ul>
        
        <h3>3. Documentation</h3>
        <ul>
            <li>Created a guide for creating Cloudflare API tokens with the correct permissions</li>
            <li>Added troubleshooting steps for common API authentication issues</li>
        </ul>
    </section>
    
    <section id="technical-details">
        <h2>Technical Details</h2>
        <p>The issue was caused by IP restrictions on the Cloudflare API token, which prevented the token from being used from the server where Comserv2 is running. The error message "Cannot use the access token from location: [IP address]" indicates that the token is restricted to specific IP addresses.</p>
        
        <p>The solution is to create a new API token without IP restrictions and with the correct permissions for DNS management.</p>
    </section>
    
    <section id="how-to-fix">
        <h2>How to Fix</h2>
        <ol>
            <li>Create a new Cloudflare API token without IP restrictions (see the guide in <a href="/documentation/cloudflare_api_token_guide">/Documentation/cloudflare_api_token_guide.tt</a>)</li>
            <li>Update the <code>cloudflare_config.json</code> file with the new token</li>
            <li>Test the new token using the provided test script</li>
        </ol>
    </section>
    
    <section id="related-files">
        <h2>Related Files</h2>
        <ul>
            <li><code>/lib/Comserv/Util/CloudflareManager.pm</code></li>
            <li><code>/config/cloudflare_config.json</code></li>
            <li><code>/script/test_cloudflare_domain.pl</code></li>
            <li><code>/Documentation/cloudflare_api_token_guide.tt</code></li>
        </ul>
    </section>
</div>

<style>
    .changelog-entry {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }
    
    .changelog-metadata {
        background-color: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin-bottom: 30px;
    }
    
    section {
        margin-bottom: 40px;
    }
    
    h3 {
        margin-top: 20px;
        color: #333;
    }
    
    code {
        background-color: #f5f5f5;
        padding: 2px 5px;
        border-radius: 3px;
        font-family: monospace;
    }
</style>