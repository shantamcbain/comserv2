<!-- File: /home/shanta/PycharmProjects/comserv/Comserv/root/Documentation/index.tt -->
[% PageVersion = 'Documentation/index.tt,v 1.6 2025/04/08 shanta Exp shanta ' %]
[% IF c.session.debug_mode == 1 %]
    [% PageVersion %]
[% END %]
<head>
    <!-- <link rel="stylesheet" href="[% c.uri_for('/static/css/components/documentation.css') %]"> -->
</head>
[%# Determine user role for display %]
[% SET display_role = 'Guest' %]
[% IF c.session.roles %]
    [% IF c.session.roles.grep('admin').size %]
        [% SET display_role = 'Administrator' %]
    [% ELSIF c.session.roles.grep('developer').size %]
        [% SET display_role = 'Developer' %]
    [% ELSIF c.session.roles.grep('editor').size %]
        [% SET display_role = 'Editor' %]
    [% ELSIF c.session.roles.grep('user').size %]
        [% SET display_role = 'User' %]
    [% END %]
[% END %]

[% IF c.session.debug_mode == 1 %]
<div class="debug">
    <h3>Debug Information</h3>
    <p>User Role from Controller: [% user_role %]</p>
    <p>Display Role from Template: [% display_role %]</p>
    <p>Session Roles: [% c.session.roles.join(', ') IF c.session.roles %]</p>
    <p>Debug Message: [% debug_msg %]</p>
    <p>Categories Available:</p>
    <ul>
        <li>user_guides: [% categories.user_guides ? 'Yes' : 'No' %]</li>
        <li>tutorials: [% categories.tutorials ? 'Yes' : 'No' %]</li>
        <li>site_specific: [% categories.site_specific ? 'Yes' : 'No' %]</li>
        <li>admin_guides: [% categories.admin_guides ? 'Yes' : 'No' %]</li>
        <li>proxmox: [% categories.proxmox ? 'Yes' : 'No' %]</li>
        <li>controllers: [% categories.controllers ? 'Yes' : 'No' %]</li>
        <li>models: [% categories.models ? 'Yes' : 'No' %]</li>
        <li>changelog: [% categories.changelog ? 'Yes' : 'No' %]</li>
        <li>general: [% categories.general ? 'Yes' : 'No' %]</li>
    </ul>
    
    <h4>Changelog Entries:</h4>
    <ul>
        [% IF categories.changelog && categories.changelog.pages.size > 0 %]
            [% FOREACH page_name IN categories.changelog.pages.sort.reverse %]
                [% page = structured_pages.$page_name %]
                <li>
                    [% page_name %] - 
                    Title: [% page.title %], 
                    Description: [% page.description %], 
                    Date: [% page.date %]
                </li>
            [% END %]
        [% ELSE %]
            <li>No changelog entries found.</li>
        [% END %]
    </ul>
    
    <h4>Controller Documentation Files:</h4>
    <ul>
        [% IF categories.controllers && categories.controllers.pages.size > 0 %]
            [% FOREACH page_name IN categories.controllers.pages.sort %]
                <li>[% page_name %] - [% structured_pages.$page_name ? 'Found' : 'Not Found' %]</li>
            [% END %]
        [% ELSE %]
            <li>No controller documentation files found.</li>
        [% END %]
    </ul>
    
    <h4>Model Documentation Files:</h4>
    <ul>
        [% IF categories.models && categories.models.pages.size > 0 %]
            [% FOREACH page_name IN categories.models.pages.sort %]
                <li>[% page_name %] - [% structured_pages.$page_name ? 'Found' : 'Not Found' %]</li>
            [% END %]
        [% ELSE %]
            <li>No model documentation files found.</li>
        [% END %]
    </ul>
</div>
[% END %]

<div class="container">
    <header class="header">
        <h1>Comserv Documentation</h1>
        <div class="context">
            <span class="context-item"><strong>Site:</strong> [% site_name || 'Comserv' %]</span>
            <span class="context-item"><strong>Role:</strong> [% display_role %]</span>
        </div>
    </header>
    <p class="intro">Comprehensive guides and resources for the Comserv system, tailored to your role and site.</p>
    
    [% IF is_admin %]
    <!-- Quick Access Links for Admins -->
    <div class="highlight-section">
        <h2>Quick Access for Administrators</h2>
        <div class="grid">
            <a href="[% c.uri_for('/Documentation/proxmox_commands.tt') %]" class="card">
                <h3>Proxmox Command Reference</h3>
                <p>Essential commands for managing Proxmox VE environments</p>
                <span class="badge badge-warning">Admin Only</span>
            </a>
            <a href="[% c.uri_for('/Documentation/api') %]" class="card">
                <h3>API Documentation</h3>
                <p>Comprehensive API reference and usage guide</p>
                <span class="badge badge-warning">Admin Only</span>
            </a>
            <a href="[% c.uri_for('/api_credentials') %]" class="card">
                <h3>API Credentials Management</h3>
                <p>Manage credentials for external service integrations</p>
                <span class="badge badge-warning">Admin Only</span>
            </a>
            <a href="[% c.uri_for('/Documentation/developer/css_theme_system_rules.tt') %]" class="card">
                <h3>CSS Theme System Rules</h3>
                <p>Mandatory guidelines for CSS and theme development</p>
                <span class="badge badge-warning">Developer Guide</span>
            </a>
            <!-- Add more quick links here as needed -->
        </div>
    </div>
    [% END %]

    [%# User-facing sections %]
    [% INCLUDE 'Documentation/user_docs.tt' %]
    [% INCLUDE 'Documentation/tutorials.tt' %]
    [% INCLUDE 'Documentation/site_specific.tt' %]
    [% INCLUDE 'Documentation/developer_guides.tt' %]

    [%# Admin-only sections %]
    [% # Use the is_admin flag passed from the controller %]
    [% IF is_admin %]
        [% # Debug output %]
        [% IF c.session.debug_mode == 1 %]
            <div class="debug">
                <p>Admin sections visible: user_role=[% user_role %], session roles=[% c.session.roles.join(',') IF c.session.roles %]</p>
            </div>
        [% END %]
        [% INCLUDE 'Documentation/admin_guides.tt' %]
        [% INCLUDE 'Documentation/proxmox.tt' %]
        [% INCLUDE 'Documentation/controllers.tt' %]
        [% INCLUDE 'Documentation/models.tt' %]
        [% INCLUDE 'Documentation/changelog.tt' %]
        [% INCLUDE 'Documentation/all_docs.tt' %]
    [% END %]

    [%# Admin/Developer/Debug sections %]
    [% IF display_role == 'Administrator' || display_role == 'Developer' || c.session.debug_mode == 1 %]
        [% INCLUDE 'Documentation/system_info.tt' %]
    [% END %]

    [% # Recent Updates Section with direct changelog entries %]
    <section class="section">
        <h2 class="section-header toggle">Recent Updates</h2>
        <div class="section-content collapsible">
            <div class="changelog-header">
                <h3>Latest changes and improvements to the system</h3>
                <a href="[% c.uri_for('/Documentation/all_changelog') %]" class="view-all-link">View All Documentation</a>
            </div>
            
            [% # Get all changelog pages from the structured_pages hash %]
            [% changelog_pages = [] %]
            [% FOREACH page_name IN structured_pages.keys %]
                [% # Check if the page is in the changelog directory %]
                [% IF structured_pages.$page_name.path.match('Documentation/changelog/') %]
                    [% changelog_pages.push(page_name) %]
                [% END %]
            [% END %]
            
            [% # Sort changelog pages by date in the filename (if available) %]
            [% date_sorted_pages = [] %]
            [% FOREACH page_name IN changelog_pages %]
                [% # Extract date from filename if it exists (format: YYYY-MM-DD) %]
                [% date_match = page_name.match('(\d{4}-\d{2}(-\d{2})?)') %]
                [% sort_key = date_match ? date_match.0 : page_name %]
                [% date_sorted_pages.push({ name => page_name, sort_key => sort_key }) %]
            [% END %]
            
            [% # Sort by the extracted date in reverse order (newest first) %]
            [% date_sorted_pages = date_sorted_pages.sort('sort_key').reverse %]
            
            [% # Display only the 5 most recent entries %]
            [% recent_count = 0 %]
            [% FOREACH page_info IN date_sorted_pages %]
                [% LAST IF recent_count >= 5 %]
                [% page_name = page_info.name %]
                [% page = structured_pages.$page_name %]
                [% recent_count = recent_count + 1 %]
                
                [% # Extract date from filename if it exists (format: YYYY-MM-DD) %]
                [% date_match = page_name.match('(\d{4}-\d{2}(-\d{2})?)') %]
                [% changelog_date = date_match ? date_match.0 : 'Recent' %]
                [% # Replace hyphens with slashes for better display %]
                [% changelog_date = changelog_date.replace('-', '/') %]
                
                <div class="changelog-summary">
                    <h3>[% page.title %]</h3>
                    <div class="changelog-meta">
                        <span class="date">[% changelog_date %]</span>
                        [% IF page.author %]<span class="author">by [% page.author %]</span>[% END %]
                    </div>
                    <p>[% page.description || 'System update' %]</p>
                    <a href="[% page.url %]" class="read-more">Read full details</a>
                </div>
            [% END %]
            
            [% IF recent_count == 0 %]
                <p>No recent updates available.</p>
            [% END %]
        </div>
    </section>
</div>

<!-- CSS moved to /static/css/themes/documentation.css for theme consistency -->

<script>
    // Universal toggle functionality for collapsible sections
    document.addEventListener('DOMContentLoaded', function() {
        // Add click event listeners to all toggle headers
        const toggleHeaders = document.querySelectorAll('.section-header.toggle');
        
        toggleHeaders.forEach(header => {
            header.addEventListener('click', function(e) {
                e.preventDefault();
                
                // Toggle the expanded class on the header
                header.classList.toggle('expanded');
                
                // Find the content section
                const section = header.closest('.section');
                if (!section) return;
                
                const content = section.querySelector('.section-content.collapsible');
                if (!content) return;
                
                // Toggle the expanded state
                if (content.classList.contains('expanded')) {
                    content.style.maxHeight = '0px';
                    content.classList.remove('expanded');
                } else {
                    content.classList.add('expanded');
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            });
        });
        
        // Start with all collapsible sections closed
        document.querySelectorAll('.section-content.collapsible').forEach(content => {
            content.classList.remove('expanded');
            content.style.maxHeight = '0px';
        });
    });

    // Function for the file type tabs
    function showFileType(evt, fileType) {
        console.log("Showing file type:", fileType);
        
        // Hide all file type content sections
        var contents = document.querySelectorAll('.file-type-content');
        contents.forEach(content => {
            content.style.display = 'none';
            content.classList.remove('active');
        });
        
        // Deactivate all tabs
        var tabs = document.querySelectorAll('.file-type-tab');
        tabs.forEach(tab => {
            tab.classList.remove('active');
        });
        
        // Show and activate the selected content and tab
        var activeContent = document.getElementById(fileType);
        if (activeContent) {
            activeContent.style.display = 'grid';
            activeContent.classList.add('active');
            evt.currentTarget.classList.add('active');
            console.log("Activated content:", fileType);
        } else {
            console.log("Content not found for:", fileType);
        }
    }
</script>

<!-- All CSS moved to theme system - NO INLINE STYLES ALLOWED -->